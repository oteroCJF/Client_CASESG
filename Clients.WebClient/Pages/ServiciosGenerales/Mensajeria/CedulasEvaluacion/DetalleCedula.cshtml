@page "/mensajeria/{moduloId}/{submoduloId}/detalle/{inmueble}/{cedula}"
@model Clients.WebClient.Pages.Mensajeria.CedulasEvaluacion.DetalleModel;
@{
    ViewData["Titulo"] = "";

    <div class="titulo-principal">
        <b>Servicio de Mensajería Acelerada</b> <i class="far fa-shipping-fast mr-1"></i>
        <a href="/mensajeria/cedulasEvaluacion/@Model.Modulo.Id/@Model.Submodulo.Id/index?Anio=@Model.Cedula.Anio&@Request.QueryString.Value" type='button' class="btn btn-sm  botonregreso btn-warning float-right btnRegresar col-1 ml-2" data-toggle="tooltip" title="Regresar a las cédulas" data-placement="top">
            <i class="fal fa-arrow-left"></i>
        </a>

        @if (@Model.Cedula.Estatus.Nombre.Equals("Autorizada") || @Model.Cedula.Estatus.Nombre.Equals("Autorizado CAE") ||
            @Model.Cedula.Estatus.Nombre.Equals("Trámite Rechazado") || @Model.Cedula.Estatus.Nombre.Equals("En Trámite") ||
            @Model.Cedula.Estatus.Nombre.Equals("Trámite de Pago"))
        {
            <a href="#" type='button' class="btn btn-sm btn-danger float-right ml-2 solicitudRechazo botonregreso" data-toggle="tooltip"
               title="Solicitar rechazo de la cédula" data-placement="top">
                <i class="fal fa-times-circle"></i>
            </a>
        }
    </div>

    ViewData["Title"] = "Detalle - " + Model.Inmueble.Nombre;
    ViewData["Action"] = "Facturación / Detalle de Facturación";
    var i = 0;
    var ci = 0;
    var cf = 0;
    var ce = 0;
    var lc = 0;
    var sp = 0;
    decimal deductivaCalidad = Model.Cedula.Penalizacion;
    decimal tpenalizacion = 0;
    decimal tdeductivas = 0;
    decimal tdeductivasB = 0;
    var pDeductivas = Model.Cedula.respuestas.Where(r => r.cuestionario.Tipo.Equals("Deductiva")).Select(c => c.cuestionario.Consecutivo);
    var pPenalizacion = Model.Cedula.respuestas.Where(r => r.cuestionario.Tipo.Equals("Penalizacion")).Select(c => c.cuestionario.Consecutivo);
}

@*<div class="row col-lg-12">
        <div class="col-lg-12">
            @if (@Model.Cedula.Estatus.Nombre.Equals("Autorizada") || @Model.Cedula.Estatus.Nombre.Equals("Autorizado CAE") ||
             @Model.Cedula.Estatus.Nombre.Equals("Trámite Rechazado") || @Model.Cedula.Estatus.Nombre.Equals("En Trámite") ||
             @Model.Cedula.Estatus.Nombre.Equals("Trámite de Pago"))
            {
                <a href="#" type='button' class="btn btn-sm btn-danger float-right ml-2 solicitudRechazo" data-toggle="tooltip"
                   title="Solicitar rechazo de la cédula" data-placement="top">
                    <i class="fal fa-times-circle"></i>
                </a>
            }
        </div>
    </div>*@

<div class="row col-lg-12 mt-3">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header cabeceraInformacion">
                <i class="fa-sharp fa-light fa-list-check mr-2"></i> Información
            </div>
            <div class="card-body" id="cuerpoInformacion">
                <div class="row col-lg-12">
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header cabeceraInformacionG">
                                <i class="fa-sharp fa-light fa-list-check mr-2"></i> General
                            </div>
                            <div class="card-body" id="cuerpoInformacionG">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <ul class="mb-0 fa-ul">
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-calendar"></i></span>Evaluación correspondiente al mes de<b>@Model.Cedula.Mes.Nombre</b> del año <b>@Model.Cedula.Anio</b></li>
                                            <li class="small mt-3"><b class="mr-1 @Model.Cedula.Estatus.Fondo.Replace("bg","text")"><span class="fa-li"><i class="fas fa-lg fa-check"></i></span>Estatus: @Model.Cedula.Estatus.Nombre</b></li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-dollar-sign"></i></span> <b>Facturación Total: </b>: @String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", Model.Facturas.Where(f => !f.Tipo.Equals("NC")).Sum(f => f.Total))</li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fad fa-star"></i></span> <b>Calificación: </b> @Model.Cedula.Calificacion</li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-user"></i></span> <b>Elaboró: </b> @Model.Cedula.Usuario.NombreEmp @Model.Cedula.Usuario.PaternoEmp @Model.Cedula.Usuario.MaternoEmp</li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-mailbox"></i></span> <b>Correo: </b> @Model.Cedula.Usuario.Email</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header cabeceraContrato">
                                <i class="fa-sharp fa-light fa-file-contract mr-2"></i> Contrato
                            </div>
                            <div class="card-body" id="cuerpoContrato">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <ul class="ml-4 mb-0 fa-ul">
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-info"></i></span> <b># de Contrato: </b> @Model.Cedula.Contrato.NoContrato</li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fad fa-calendar"></i></span> <b>Vigencia: </b> Del @Model.Cedula.Contrato.InicioVigencia.ToString("dd/MM/yyyy") al @Model.Cedula.Contrato.FinVigencia.ToString("dd/MM/yyyy")</li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-building-user"></i></span> <b>Empresa: </b> @Model.Cedula.Contrato.Empresa <br /></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header cabeceraInmueble">
                                <i class="fa-sharp fa-light fa-building mr-2"></i> Inmueble
                            </div>
                            <div class="card-body" id="cuerpoInmueble">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <ul class="mb-0 fa-ul">
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-building"></i></span><b>Número de Cliente:</b> @Model.Inmueble.ClienteEstafeta</li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-building-circle-check"></i></span><b>Inmueble:</b> @Model.Inmueble.Nombre</li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-building-user"></i></span><b>Administración:</b> @Model.Inmueble.Descripcion</li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-address-card"></i></span><b>Dirección:</b> @Model.Inmueble.Direccion</li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-user"></i></span><b>Administrador:</b> @Model.Inmueble.Administrador</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row col-lg-12 mt-3" id="divFacturacion">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header cabeceraFacturacion">
                <i class="fa-sharp fa-light fa-money-bill-1-wave mr-2"></i> Facturación
            </div>
            <div class="card-body cuerpoFacturacion" style="display: none">
                <div class="row col-lg-12 mt-3">
                    <h5> Factura(s) y/o Nota(s) de Crédito</h5>
                    <div class="col-lg-12 mt-3 ml-2">
                        <table class="table tblIncidencias tablaFacturas" width="100%">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Estatus</th>
                                    <th>Tipo</th>
                                    <th>Empresa</th>
                                    <th>Folio Fiscal</th>
                                    <th>Número</th>
                                    <th>Subtotal</th>
                                    <th>IVA</th>
                                    <th>Total</th>
                                    <th>Fecha de Carga</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="AA">
                                @{ 
                                    // Aquí es donde defines y calculas totalNotasCredito
                                    decimal totalNotasCredito = Model.Facturas?.Where(f => f.Tipo.Equals("NC")).Sum(f => (decimal?)f.Total) ?? 0M;

                                  }
                                @foreach (var fac in Model.Facturas)
                                {
                                    i++;

                                    <tr>
                                        <td>@i</td>
                                        <td class="@fac.Estatus.Fondo.Replace("bg","text") font-weight-bold">@fac.Estatus.Nombre</td>
                                        <td>@(fac.Tipo.Equals("NC") ? "Nota de Crédito":"Factura")</td>
                                        <td>@fac.Nombre</td>
                                        <td>
                                            @fac.UUID
                                        </td>
                                        <td>@fac.Folio</td>
                                        <td class="text-right">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.Subtotal)</td>
                                        <td class="text-right">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.IVA)</td>
                                        <td class="text-right">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.Total)</td>
                                        <td>@fac.FechaCreacion.ToString("dd/MMMM/yyyy", @System.Globalization.CultureInfo.CreateSpecificCulture("es"))</td>
                                        <td class="text-center">
                                            <a href="#" class="viewConceptosF" id="viewConceptos_@fac.Id" data-factura="@fac.Id" data-toggle="tooltip" title="Mostrar/Ocultar el detalle de la factura" data-placement="top">
                                                <i class="fas fa-eye text-success mr-2"></i>
                                            </a>
                                            <a href="javascript:" class="verFactura" data-tipo="@fac.Tipo" data-archivo="@fac.ArchivoPDF"
                                               data-folio="@(fac.Serie+fac.Folio)" data-subtotal="@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.Subtotal)"
                                               data-total="@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.Total)"
                                               data-iva="@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", fac.IVA)"
                                               data-toggle="tooltip" title="Ver y descargar el PDF" data-placement="top">
                                                <i class='fa-solid fa-file-pdf text-danger'></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="col-lg-12 mt-3 ml-2 mb-3">
                        @foreach (var fac in Model.Facturas)
                        {
                            cf = 0;
                            <div class="row col-lg-12">
                                <div class="col-lg-12">
                                    <div class="conceptosFactura" id="conceptoFactura_@fac.Id">
                                        <h3>Conceptos de la @(fac.Tipo.Equals("Factura") ? "Factura" : "Nota de Crédito") con Folio: @fac.Folio</h3>
                                        <table id="@fac.Folio" style="width: 90%" class="table tableConceptos mt-3 float-right">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Cantidad</th>
                                                    <th>Unidad</th>
                                                    <th>Descripción</th>
                                                    <th>Precio Unitario</th>
                                                    <th>SubTotal</th>
                                                    <th>IVA</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var con in fac.ConceptosFactura)
                                                {
                                                    if (@fac.Id == con.FacturaId)
                                                    {
                                                        cf++;
                                                        <tr>
                                                            <td>@cf</td>
                                                            <td class="text-right">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:n0}", con.Cantidad)</td>
                                                            <td>@con.Unidad</td>
                                                            <td>@con.Descripcion</td>
                                                            <td class="text-right">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.PrecioUnitario)</td>
                                                            <td class="text-right">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.Subtotal)</td>
                                                            <td class="text-right">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.IVA)</td>
                                                            <td class="text-right">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", con.Subtotal + con.IVA)</td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (Model.Cedula.Id != 0)
{
    <div class="row col-lg-12 mt-3" id="divCedula">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header cabeceraCedula">
                    <i class="fas fa-list-check mr-2"></i> Cédula de Evaluación
                </div>
                <div class="card-body cuerpoCedula">
                    <table class="table table-borderless">
                        <tr>
                            <td data-toggle="tooltip" title="Folio de evaluación asignado por el sistema" data-placement="top" style="font-family: Tahoma; font-size: 13.5px; letter-spacing: 0.8px;"><strong>Folio: </strong> @Model.Cedula.Folio</td>
                            <td data-toggle="tooltip" title="Año de evaluación del servicio" data-placement="top"><strong>Año: </strong>@Model.Cedula.Anio</td>
                            <td data-toggle="tooltip" title="Mes evaluado" data-placement="top"><strong>Mes: </strong>@Model.Cedula.Mes.Nombre</td>
                            <td data-toggle="tooltip" title="Administración/Inmueble evaluado" data-placement="top"><strong>Inmueble: </strong>@Model.Cedula.Inmueble.Nombre</td>
                            <td data-toggle="tooltip" title="Estatus de la cédula" data-placement="top">
                                <strong style="color: @(Model.Cedula.Estatus.FondoHexadecimal)"><b class="mr-1">Estatus:</b> @Html.Raw(Model.Cedula.Estatus.Icono) @Model.Cedula.Estatus.Nombre</strong>
                            </td>
                        </tr>
                    </table>
                    <div class="row col-lg-12 mt-3">
                        <div class="col-md-12">
                            <ul class="nav nav-tabs" id="myTab" role="tablist">
                                @foreach (var rs in Model.Cedula.respuestas)
                                {
                                    <li class="nav-item" role="presentation">
                                        <a class="nav-link" id="pregunta_@rs.cuestionario.Abreviacion" data-toggle="tab" href="#@rs.cuestionario.Abreviacion" role="tab" aria-controls="pregunta" aria-selected="false">
                                            @if (rs.Respuesta != null)
                                            {
                                                <i class="fas fa-circle-check mr-2 text-success"></i> @Html.Raw("<b style='color: black;'>Pregunta " + @rs.Pregunta + "</b>")
                                            }
                                            else
                                            {
                                                <i class="fas fa-circle-xmark mr-2 text-danger"></i> @Html.Raw("<b style='color: black;'>Pregunta " + @rs.Pregunta + "</b>")
                                            }
                                        </a>
                                    </li>
                                }
                            </ul>
                            <div class="tab-content" id="myTabContent">
                                @foreach (var rs in Model.Cedula.respuestas)
                                {
                                    <div class="tab-pane fade mt-2 ml-3 " id="@rs.cuestionario.Abreviacion" role="tabpanel" aria-labelledby="pregunta-tab">
                                        <div class="row col-lg-12 h5 mt-3">
                                            <div class="col-lg-10">
                                                @rs.Pregunta.- @rs.cuestionario.Pregunta
                                                <a href="javascript:" class="text-primary ml-2 btnAyuda" data-toggle="tooltip" title="Ayuda" data-placement="top" data-ayuda="@rs.cuestionario.Ayuda">
                                                    <i class="fa-solid fa-circle-question"></i>
                                                </a>
                                                @if (Model.Permisos.Where(p => p.Permiso.Abreviacion.Equals("actualizar")).Count() != 0)
                                                {
                                                    @if (Model.Cedula.Estatus.Nombre.Equals("Rechazada") || Model.Cedula.Estatus.Nombre.Equals("En Proceso") ||
                                              Model.Cedula.Estatus.Nombre.Equals("Sin Iniciar"))
                                                    {
                                                        <div class="row col-lg-6 mt-2">
                                                            <div class="icheck-success d-inline">
                                                                <input type="radio" name="@rs.cuestionario.Abreviacion" value="true" id="@String.Concat("radioSuccess", @i)" class="pregunta" data-pregunta="@rs.cuestionario.NoPregunta"
                                                                       data-pusuario="@rs.cuestionario.Consecutivo"
                                                                       data-obligatorio="@rs.ciMensajeria.Obligatorio"
                                                                       data-respuesta="@rs.ciMensajeria.Respuesta"
                                                                       data-abreviacion="@rs.cuestionario.Abreviacion">
                                                                <label for="@String.Concat("radioSuccess", @i)">Si</label>
                                                            </div>
                                                            @{
                                                                i++;
                                                            }
                                                            <div class="icheck-success d-inline ml-3">
                                                                <input type="radio" name="@rs.cuestionario.Abreviacion" value="false" id="@String.Concat("radioSuccess", @i)" class="pregunta" data-pregunta="@rs.cuestionario.NoPregunta"
                                                                       data-pusuario="@rs.cuestionario.Consecutivo"
                                                                       data-obligatorio="@rs.ciMensajeria.Obligatorio"
                                                                       data-respuesta="@rs.ciMensajeria.Respuesta"
                                                                       data-abreviacion="@rs.cuestionario.Abreviacion">
                                                                <label for="@String.Concat("radioSuccess", @i)">No</label>
                                                            </div>
                                                            @{
                                                                i++;
                                                            }
                                                            @if (@rs.cuestionario.NoAplica)
                                                            {
                                                                <div class="icheck-success d-inline ml-3">
                                                                    <input type="radio" name="@rs.cuestionario.Abreviacion" value="N/A" id="@String.Concat("radioSuccess", @i)" class="pregunta" data-pregunta="@rs.cuestionario.NoPregunta"
                                                                           data-pusuario="@rs.cuestionario.NoPregunta"
                                                                           data-obligatorio="@rs.ciMensajeria.Obligatorio"
                                                                           data-respuesta="@rs.ciMensajeria.Respuesta"
                                                                           data-abreviacion="@rs.cuestionario.Abreviacion">
                                                                    <label for="@String.Concat("radioSuccess", @i)">N/A</label>
                                                                </div>
                                                                i++;
                                                            }
                                                        </div>
                                                    }
                                                }
                                            </div>
                                            <div class="col-lg-12 mt-2">
                                                @if (Model.Permisos.Where(p => p.Permiso.Abreviacion.Equals("actualizar")).Count() != 0)
                                                {
                                                    @if (Model.Cedula.Estatus.Nombre.Equals("Rechazada") || Model.Cedula.Estatus.Nombre.Equals("En Proceso") || Model.Cedula.Estatus.Nombre.Equals("Bloqueada") ||
                                              Model.Cedula.Estatus.Nombre.Equals("Sin Iniciar"))
                                                    {
                                                        @if (rs.cuestionario.Incidencias && rs.ciMensajeria.Obligatorio && !rs.Detalles.Equals("N/A"))
                                                        {
                                                            <a href="javascript:" class="addIncidencia btn btn-sm btn-primary" data-pregunta="@rs.cuestionario.Consecutivo"
                                                               data-preguntaid="@rs.cuestionario.Id"
                                                               data-cedula="@rs.CedulaEvaluacionId"
                                                               data-abreviacion="@rs.cuestionario.Abreviacion"
                                                               data-titulo="@Model.CTIncidencias.Single(i=> i.Abreviacion.Equals(rs.cuestionario.Abreviacion)).Valor"
                                                               data-respuesta="@rs.Respuesta"
                                                               data-ayuda="@rs.ciMensajeria.Ayuda"
                                                               data-incidenciaid="@Model.CTIncidencias.Single(i=> i.Abreviacion.Equals(rs.cuestionario.Abreviacion)).Id"
                                                               data-toggle="tooltip" title="Agregar nueva incidencia" data-placement="top">
                                                                <i class="fas fa-plus mr-1"></i> Registrar Incidencia
                                                            </a>

                                                            @if (rs.cuestionario.CargaMasiva)
                                                            {
                                                                <a href="javascript:" class="addIncidenciaExcel btn btn-sm btn-success" data-pregunta="@rs.cuestionario.Consecutivo"
                                                                   data-preguntaid="@rs.cuestionario.Id"
                                                                   data-cedula="@rs.CedulaEvaluacionId"
                                                                   data-abreviacion="@rs.cuestionario.Abreviacion"
                                                                   data-titulo="@Model.CTIncidencias.Single(i=> i.Abreviacion.Equals(rs.cuestionario.Abreviacion)).Valor"
                                                                   data-respuesta="@rs.Respuesta"
                                                                   data-incidenciaid="@Model.CTIncidencias.Single(i=> i.Abreviacion.Equals(rs.cuestionario.Abreviacion)).Id"
                                                                   data-toggle="tooltip" title="Agregar archivo concentrado de incidencias" data-placement="top">
                                                                    <i class="fal fa-file-excel mr-1"></i> Adjuntar Excel
                                                                </a>
                                                                <a href="javascript:" class="descargarPlantilla btn btn-sm btn-dark"
                                                                   data-toggle="tooltip" title="Descargar plantilla de incidencias" data-placement="top">
                                                                    <i class="fal fa-cloud mr-1"></i> Descargar Excel
                                                                </a>
                                                            }
                                                        }
                                                    }
                                                }
                                            </div>
                                        </div>
                                        @if (rs.cuestionario.Incidencias && rs.iMensajeria.Count() != 0)
                                        {
                                            ci = 0;
                                            <div class="row mt-3">
                                                <div class="col-lg-12">
                                                    <table class="table tblIncidencias dataTables" width="100%">
                                                        <thead>
                                                            <tr>
                                                                <th>#</th>
                                                                <th>Tipo</th>
                                                                @if (@rs.ciMensajeria.FechaProgramada)
                                                                {
                                                                    <th class="text-center">Fecha programada</th>
                                                                }
                                                                @if (@rs.ciMensajeria.FechaEntrega)
                                                                {
                                                                    <th class="text-center">Fecha de entrega</th>
                                                                }

                                                                @if (@rs.ciMensajeria.NumeroGuia)
                                                                {
                                                                    <th class="text-center">Número de guía</th>
                                                                }

                                                                @if (@rs.ciMensajeria.CodigoRastreo)
                                                                {
                                                                    <th class="text-center">Código de rastreo</th>
                                                                }

                                                                @if (@rs.ciMensajeria.Acuse)
                                                                {
                                                                    <th class="text-center">Acuse</th>
                                                                }

                                                                @if (@rs.ciMensajeria.Sobrepeso)
                                                                {
                                                                    <th class="text-center">Sobrepeso (Kg)</th>
                                                                }

                                                                @if (@rs.ciMensajeria.TipoServicio)
                                                                {
                                                                    <th class="text-center">Tipo de servicio</th>
                                                                }

                                                                @if (@rs.ciMensajeria.TipoIndemnizacion)
                                                                {
                                                                    <th class="text-center">Tipo de contenido</th>
                                                                }

                                                                @if (@rs.ciMensajeria.Acta)
                                                                {
                                                                      <th class="text-center">Acta del incidente</th>
                                                                }

                                                                @if (@rs.ciMensajeria.Escrito)
                                                                {
                                                                    <th class="text-center">Escrito robo/extravio</th>
                                                                }

                                                                @if (@rs.ciMensajeria.Comprobante)
                                                                {
                                                                    <th class="text-center">Comprobante</th>
                                                                }

                                                                @if (@rs.ciMensajeria.Observaciones)
                                                                {
                                                                    <th class="text-center">Observaciones</th>
                                                                }

                                                                @if (!Model.Cedula.Estatus.Nombre.Equals("Rechazada") && !Model.Cedula.Estatus.Nombre.Equals("En Proceso") && !Model.Cedula.Estatus.Nombre.Equals("Sin Iniciar"))
                                                                {
                                                            <th class="text-center">Monto Penalizacion</th>
                                                                }

                                                                @if (Model.Cedula.Estatus.Nombre.Equals("Rechazada") || Model.Cedula.Estatus.Nombre.Equals("En Proceso") ||
                                                 Model.Cedula.Estatus.Nombre.Equals("Sin Iniciar"))
                                                                {
                                                            <th class="text-center">Acciones</th>
                                                                }
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var inc in rs.iMensajeria)
                                                            {
                                                                ci++;
                                                                <tr>
                                                                    <td>@ci</td>
                                                                    <td>@inc.Incidencia.Valor</td>
                                                                    @if (@rs.ciMensajeria.FechaProgramada)
                                                                    {
                                                                          <td class="text-center">@Convert.ToDateTime(inc.FechaProgramada).ToString("dd/MM/yyyy")</td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.FechaEntrega)
                                                                    {
                                                                        <td class="text-center">@Convert.ToDateTime(inc.FechaEntrega).ToString("dd/MM/yyyy")</td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.NumeroGuia)
                                                                    {
                                                                        <td class="text-center">@inc.NumeroGuia</td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.CodigoRastreo)
                                                                    {
                                                                        <td class="text-center">@inc.CodigoRastreo</td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.Acuse)
                                                                    {
                                                                        <td class="text-center">@inc.Acuse</td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.Sobrepeso)
                                                                    {
                                                                        <td class="text-center">@inc.Sobrepeso</td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.TipoServicio)
                                                                    {
                                                                        <td class="text-center">@inc.TipoServicio</td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.TipoIndemnizacion)
                                                                    {
                                                                        <td class="text-center">@inc.Indemnizacion.Nombre</td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.Acta)
                                                                    {
                                                                        <td class="text-center">
                                                                            <a href="javascript:" data-guia="@inc.NumeroGuia" class="verActa"
                                                                               data-codigo="@inc.CodigoRastreo" data-tiposervicio="@inc.TipoServicio"
                                                                               data-archivo="@inc.Acta" data-sobrepeso="@inc.Sobrepeso"
                                                                               data-tipo="@inc.Incidencia.Valor"
                                                                               data-tipoarchivo="Acta MP">
                                                                                <i class="fas fa-eye text-success mr-2"></i>
                                                                            </a> @inc.Acta
                                                                        </td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.Escrito)
                                                                    {
                                                                        <td class="text-center">
                                                                            <a href="javascript:" data-guia="@inc.NumeroGuia" class="verActa"
                                                                               data-codigo="@inc.CodigoRastreo" data-tiposervicio="@inc.TipoServicio"
                                                                               data-archivo="@inc.Escrito" data-sobrepeso="@inc.Sobrepeso"
                                                                               data-tipo="@inc.Incidencia.Valor"
                                                                               data-tipoarchivo="Escrito">
                                                                                <i class="fas fa-eye text-success mr-2"></i>
                                                                            </a> @inc.Escrito
                                                                        </td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.Comprobante)
                                                                    {
                                                                        <td class="text-center">
                                                                            <a href="javascript:" data-guia="@inc.NumeroGuia" class="verActa"
                                                                               data-codigo="@inc.CodigoRastreo" data-tiposervicio="@inc.TipoServicio"
                                                                               data-archivo="@inc.Comprobante" data-sobrepeso="@inc.Sobrepeso"
                                                                               data-tipo="@inc.Incidencia.Abreviacion"
                                                                               data-tipoarchivo="Comprobante">
                                                                                <i class="fas fa-eye text-success mr-2"></i>
                                                                            </a> @inc.Comprobante
                                                                        </td>
                                                                    }
                                                                    @if (@rs.ciMensajeria.Observaciones)
                                                                    {
                                                                        <th>@inc.Observaciones</th>
                                                                    }

                                                                    @if (!Model.Cedula.Estatus.Nombre.Equals("Rechazada") && !Model.Cedula.Estatus.Nombre.Equals("En Proceso") &&
                                                              !Model.Cedula.Estatus.Nombre.Equals("Sin Iniciar"))
                                                                    {
                                                                         <td class="text-center">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @inc.MontoPenalizacion)</td>
                                                                    }

                                                                    @if (Model.Cedula.Estatus.Nombre.Equals("Rechazada") || Model.Cedula.Estatus.Nombre.Equals("En Proceso") ||
                                                              Model.Cedula.Estatus.Nombre.Equals("Sin Iniciar"))
                                                                    {
                                                                        <td class="text-center">
                                                                            <a href="javascript:" class="editIncidencia" data-pregunta="@rs.cuestionario.Consecutivo"
                                                                               data-abreviacion="@rs.cuestionario.Abreviacion" data-incidencia="@inc.Id"
                                                                               data-titulo="@Model.CTIncidencias.Single(i=> i.Abreviacion.Equals(rs.cuestionario.Abreviacion)).Valor"
                                                                               data-incidenciaid="@inc.IncidenciaId" data-preguntaid="@rs.cuestionario.Id">
                                                                                <i class="fas fa-pencil text-primary"></i>
                                                                            </a>
                                                                            <a href="javascript:" class="eliminarIncidencia ml-2"
                                                                               data-titulo="@Model.CTIncidencias.Single(i=> i.Abreviacion.Equals(rs.cuestionario.Abreviacion)).Valor"
                                                                               data-id="@inc.Id">
                                                                                <i class="fas fa-times text-danger"></i>
                                                                            </a>
                                                                        </td>
                                                                    }
                                                                </tr>
                                                            }
                                                        </tbody>
                                                        @if (!Model.Cedula.Estatus.Nombre.Equals("Rechazada") && !Model.Cedula.Estatus.Nombre.Equals("En Proceso") &&
                                                            !Model.Cedula.Estatus.Nombre.Equals("Sin Iniciar"))
                                                        {
                                                            <tfoot>
                                                                <tr>
                                                                    <td><b>Total:</b></td>
                                                                    <td></td>
                                                                    @if (@rs.ciMensajeria.FechaProgramada)
                                                                    {
                                                                        <td></td>
                                                                    }
                                                                    @if (@rs.ciMensajeria.FechaEntrega)
                                                                    {
                                                                        <td></td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.NumeroGuia)
                                                                    {
                                                                        <td></td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.CodigoRastreo)
                                                                    {
                                                                        <td></td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.Acuse)
                                                                    {
                                                                        <td></td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.Sobrepeso)
                                                                    {
                                                                        <td></td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.TipoServicio)
                                                                    {
                                                                        <td></td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.TipoIndemnizacion)
                                                                    {
                                                                        <td></td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.Acta)
                                                                    {
                                                                        <td></td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.Escrito)
                                                                    {
                                                                        <td></td>
                                                                    }

                                                                    @if (@rs.ciMensajeria.Observaciones)
                                                                    {
                                                                        <td></td>
                                                                    }
                                                                <td class="text-end py-3">
                                                                    <h3 class="text-danger fw-bold mb-0">
                                                                        <strong>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", rs.iMensajeria.Sum(i => i.MontoPenalizacion))</strong>
                                                                    </h3>
                                                                </td>                                                                </tr>
                                                            </tfoot>
                                                        }
                                                    </table>
                                                </div>
                                            </div>

                                        }
                                        else if (rs.cuestionario.Incidencias && rs.iMensajeria.Count() == 0)
                                        {
                                            ci = 0;
                                            <div class="row col-lg-12 mt-3">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Respuesta</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>1</td>
                                                            <td>@(rs.Detalles.Equals("N/A") ? "La captura de incidencias no aplica para esta evaluación.": rs.ciMensajeria.RespuestaCedula)</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row col-lg-12 mt-3" id="divEntregables">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header cabeceraEntregables">
                    <i class="fa-sharp fa-light fa-paperclip mr-2"></i> Entregables
                </div>
                <div class="card-body cuerpoEntregables" style="display: none">
                    <table class="table row-border dataTable" width="100%">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Entregable</th>
                                <th>Usuario</th>
                                <th>Archivo</th>
                                <th>Estatus</th>
                                <th>Última actualización</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var en in Model.Cedula.entregables.OrderBy(e => e.tipoEntregable.Orden))
                            {
                                var fe = Model.FlujoEntregables.SingleOrDefault(fe => fe.EntregableId == en.EntregableId && fe.Flujo.Equals(Model.Supervision)
                                                                                        && fe.EstatusId == Model.Cedula.EstatusId);
                                ce++;
                                <tr>
                                    <td>@ce</td>
                                    <td>@en.tipoEntregable.Nombre</td>
                                    <td>@(System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase((en.usuario.NombreEmp + " " + en.usuario.PaternoEmp + " " + en.usuario.MaternoEmp).ToLower()))</td>
                                    <td class="font-weight-bold @(en.Archivo != null && !en.Archivo.Equals("") ? "text-success" : "text-danger")">@(en.Archivo != null && !en.Archivo.Equals("") ? en.Archivo : "Sin Adjuntar")</td>
                                    <td style="color: @en.estatus.FondoHexadecimal; font-weight: bold;">
                                        @Html.Raw(en.estatus.Nombre + " ")
                                    </td>
                                    <td>@(Convert.ToDateTime(en.FechaActualizacion).ToString("dd/MM/yyyy").Equals("01/01/0001") ? "-" : Convert.ToDateTime(en.FechaActualizacion).ToString("dd/MM/yyyy HH:mm tt"))</td>
                                    <td>
                                        @if (en.Archivo != null && !en.Archivo.Equals(""))
                                        {
                                            <a class="verEntregable" href="javascript:" data-toggle="tooltip" title="Ver @en.tipoEntregable.Nombre"
                                               data-placement="top" data-tipo="@en.tipoEntregable.Nombre" data-id="@en.Id" data-archivo="@en.Archivo"
                                               data-observaciones="@en.Observaciones">
                                                <i class="fas fa-eye text-success mr-2"></i>
                                            </a>
                                        }

                                        @if (Model.Permisos.Where(p => p.Permiso.Abreviacion.Equals("editarEntregable")).Count() != 0 &&
                               (fe != null ? fe.Editable : false) && !en.estatus.Nombre.Equals("Autorizado"))
                                        {
                                            <a class="editarEntregable" href="javascript:" data-toggle="tooltip" title="Cargar @en.tipoEntregable.Nombre"
                                               data-placement="top" data-tipo="@en.tipoEntregable.Nombre" data-id="@en.Id"
                                               data-entregableid="@en.EntregableId" data-file="@en.Archivo">
                                                <i class="fas fa-pencil text-primary mr-2"></i>
                                            </a>
                                        }

                                        @if (!en.Archivo.Equals(""))
                                        {

                                            @if (Model.Permisos.Where(p => p.Permiso.Abreviacion.Equals("autorizarEntregable")).Count() != 0 && (fe != null ? fe.Autorizar : false)
                                    && !en.estatus.Nombre.Equals("Autorizado"))
                                            {
                                                <a class="autorizarEntregable" href="javascript:" data-toggle="tooltip" title="Autorizar @en.tipoEntregable.Nombre"
                                                   data-placement="top" data-tipo="@en.tipoEntregable.Nombre" data-id="@en.Id" data-entregableid="@en.EntregableId">
                                                    <i class="fas fa-check text-success mr-2"></i>
                                                </a>
                                            }

                                            @if (Model.Permisos.Where(p => p.Permiso.Abreviacion.Equals("rechazarEntregable")).Count() != 0 && (fe != null ? fe.Rechazar : false)
                                    && !en.estatus.Nombre.Equals("Rechazado"))
                                            {
                                                <a class="rechazarEntregable" href="javascript:" data-toggle="tooltip" title="Rechazar @en.tipoEntregable.Nombre"
                                                   data-placement="top" data-tipo="@en.tipoEntregable.Nombre" data-id="@en.Id" data-entregableid="@en.EntregableId">
                                                    <i class="fas fa-times text-danger"></i>
                                                </a>
                                            }
                                        }

                                        @if (en.tipoEntregable.Abreviacion.Equals("ActaER") && !en.estatus.Nombre.Equals("Autorizado") &&
                                      (Model.Cedula.Estatus.Nombre.Equals("Autorizada") || Model.Cedula.Estatus.Nombre.Equals("Trámite Rechazado")))
                                        {
                                            <a href="javascript:" class="generaAER">
                                                <i class="fa-sharp fa-regular fa-file-word"></i>
                                            </a>
                                        }

                                        @if (en.tipoEntregable.Abreviacion.Equals("Cedula_Firmada") && !en.estatus.Nombre.Equals("Autorizado") &&
                                       (Model.Cedula.Estatus.Nombre.Equals("Enviada a DAS") || Model.Cedula.Estatus.Nombre.Equals("Autorizada") ||
                                        Model.Cedula.Estatus.Nombre.Equals("Trámite Rechazado")))
                                        {
                                            <a class="generarCedula" href="javascript:" data-toggle="tooltip" title="Generar la Cédula de Evaluación"
                                               data-placement="top" data-tipo="@en.tipoEntregable.Nombre" data-id="@en.Id">
                                                <i class="fal fa-file-pdf text-success mr-2"></i>
                                            </a>
                                        }

                                        @if ((fe != null ? fe.Validar : false) &&
                                       en.estatus.Nombre.Equals("Autorizado") && !en.Validado)
                                        {
                                            <a class="validarEntregable" href="javascript:" data-toggle="tooltip" title="Validar @en.tipoEntregable.Nombre"
                                               data-placement="top" data-tipo="@en.tipoEntregable.Nombre" data-id="@en.Id" data-estatusid="@en.EstatusId"
                                               data-entregableid="@en.EntregableId">
                                                <i class="fa-regular fa-check-double text-primary ml-2"></i>
                                            </a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    @if (Model.Cedula.Estatus.Nombre.Equals("Rechazada") || Model.Cedula.Estatus.Nombre.Equals("En Proceso") ||
            Model.Cedula.Estatus.Nombre.Equals("Sin Iniciar"))
                    {
                        <a href="javascript:" class="btn btn-sm btn-primary guardarCedula float-right">
                            Guardar Respuestas
                        </a>

                    }
                    @foreach (var bt in Model.Flujo)
                    {
                        if (bt.EstatusId == Model.Cedula.EstatusId && Model.Permisos.Where(p => p.Permiso.Abreviacion.Equals(bt.ESucesivo.Abreviacion)).Count() > 0)
                        {
                            @Html.Raw(bt.Boton)
                        }
                    }

                    @if (Model.Cedula.Bloqueada && Model.Permisos.Where(p => p.Permiso.Abreviacion.Equals("denegar")).Count() > 0)
                    {
                        <a href="javascript:" class="btn btn-sm bg-correccion denegarRechazo float-right mr-2"
                           data-estatus="Denegar el rechazo de la cédula">
                            Denegar Rechazo
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (Model.Cedula.EstatusId > 2 && (Model.Cedula.respuestas.Sum(r => r.MontoPenalizacion) != (decimal)0 || Model.Cedula.Penalizacion != (decimal)0))
    {
        <div class="row col-lg-12 mt-4" id="divPenalizaciones">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header cabeceraPenalizaciones">
                        <i class="fa-regular fa-messages-dollar mr-2"></i> Penalizaciones y deductivas
                    </div>
                    <div class="card-body cuerpoPenalizaciones" style="display: none">
                        <p class="text-justify text-primary font-weight-bold h5">Únicamente solicitar al prestador de servicios la nota de crédito por el(los) concepto(s) del total de deductivas, en caso de que aplique.</p>
                        <ul class="mb-0 fa-ul">
                            <li class="medium mt-3"><span class="fa-li"><i class="fas fa-lg fa-calendar"></i></span>Evaluación correspondiente al mes de <b>@Model.Cedula.Mes.Nombre</b> del año <b>@Model.Cedula.Anio</b></li>
                            <li class="medium mt-3"><span class="fa-li"><i class="fas fa-lg fa-building-circle-check"></i></span><b>Inmueble:</b> @Model.Inmueble.Nombre</li>
                        </ul>

                        @{ // Calcular tdeductivas *antes* de la condición del if
                            // Esto es vital para que la condición sepa si hay algo que mostrar.
                            // También asegúrate de que 'rs.cuestionario.Tipo' exista y sea comparable.
                            foreach (var rs in Model.Cedula.respuestas)
                            {
                                if (rs.Pregunta == 7 || rs.Pregunta == 11 && rs.MontoPenalizacion != 0 && rs.cuestionario.Tipo != null && rs.cuestionario.Tipo.Equals("Deductiva"))
                                {
                                    tdeductivasB += (decimal)rs.MontoPenalizacion;
                                }
                            }
                        }

                        @if (tdeductivasB != 0 || deductivaCalidad != 0)
                        {
                            <h5 class="mt-4 text-center font-weight-bold">Deductivas Aplicadas sin IVA</h5>
                            <table class="table table-hover table-bordered dataTable" width="100%">
                                <thead>
                                    <tr>
                                        <th class="text-center">Pregunta</th>
                                        <th class="text-center">Tipo</th>
                                        <th class="text-center">Concepto</th>
                                        <th class="text-right">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var rs in Model.Cedula.respuestas)
                                    {
                                        // Omitir elementos con rs.Pregunta igual a 7 o 11
                                        if ((rs.Pregunta == 7 || rs.Pregunta == 11) && rs.Penalizable == true && rs.cuestionario.Tipo != null && rs.cuestionario.Tipo.Equals("Deductiva"))
                                        {
                                            <tr>
                                                <td class="text-center">@rs.Pregunta</td>
                                                <td class="text-center">Deductiva</td>
                                                <td class="text-center">@Html.Raw(rs.cuestionario.Icono) @rs.cuestionario.Concepto</td>
                                                <td class="text-right-lg font-weight-bold">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @rs.MontoPenalizacion)</td>
                                            </tr>
                                        }
                                    }
                                    @if (deductivaCalidad != 0)
                                    {
                                        <tr>
                                            <td class="text-center">-</td>
                                            <td class="text-center">Deductiva</td>
                                            <td class="text-center"><i class="fa-sharp fa-regular fa-thumbs-up mr-2"></i> Calidad y eficiencia del servicio</td>
                                            <td class="text-right-lg font-weight-bold">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", deductivaCalidad)</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr class="font-weight-bold text-primary bg-light">
                                        <td colspan="3" class="text-right-lg">Total de Deductivas sin IVA</td>
                                        <td class="text-right-lg font-weight-bold">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", (deductivaCalidad + tdeductivasB))</td>
                                    </tr>
                                    <tr class="font-weight-bold text-primary bg-light">
                                        <td colspan="3" class="text-right-lg">Solicitar Nota de Crédito por:</td>
                                        <td class="text-right-lg font-weight-bold">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", ((deductivaCalidad + tdeductivasB) * 1.16m))</td>
                                    </tr>
                                </tfoot>
                            </table>

                        }


                        @{ // Calcular tdeductivas *antes* de la condición del if
                            // Esto es vital para que la condición sepa si hay algo que mostrar.
                            // También asegúrate de que 'rs.cuestionario.Tipo' exista y sea comparable.
                            foreach (var rs in Model.Cedula.respuestas)
                            {
                                if (rs.Pregunta == 7 || rs.Pregunta == 11)
                                {
                                    continue; // Salta esta iteración si es una de las preguntas que quieres omitir
                                }

                                if (rs.MontoPenalizacion != 0 && rs.cuestionario.Tipo != null && rs.cuestionario.Tipo.Equals("Deductiva"))
                                {
                                    tdeductivas += (decimal)rs.MontoPenalizacion;
                                }
                            }
                        }

                        @if (tdeductivas != 0) // Ahora condicionamos la aparición de la tabla con el total calculado
                        {
                            <h5 class="mt-4 text-center text-primary">Deductivas Aplicadas con IVA</h5>
                            <table class="table table-hover table-bordered dataTable" width="100%">
                                <thead>
                                    <tr>
                                        <th class="text-center">Pregunta</th>
                                        <th class="text-center">Tipo</th>
                                        <th class="text-center">Concepto</th>
                                        <th class="text-right">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var rs in Model.Cedula.respuestas)
                                    {
                                        // Omitir elementos con rs.Pregunta igual a 6 o 10
                                        if (rs.Pregunta == 7 || rs.Pregunta == 11)
                                        {
                                            continue; // Salta esta iteración si es una de las preguntas que quieres omitir
                                        }

                                        // La condición original para filtrar las filas individuales
                                        if (rs.Penalizable == true && rs.cuestionario.Tipo != null && rs.cuestionario.Tipo.Equals("Deductiva"))
                                        {
                                            <tr>
                                                <td class="text-center">@rs.Pregunta</td>
                                                <td class="text-center">Deductiva</td>
                                                <td class="text-center">@Html.Raw(rs.cuestionario.Icono) @rs.cuestionario.Concepto</td>
                                                <td class="text-right-lg font-weight-bold">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @rs.MontoPenalizacion)</td>
                                            </tr>
                                        }
                                    }

                                </tbody>
                                <tfoot>
                                    <tr class="font-weight-bold text-primary bg-light">
                                        <td colspan="3" class="text-right-lg">Total de Deductivas con I.V.A.</td>
                                        <td class="text-right-lg">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", tdeductivas)</td>
                                    </tr>
                                </tfoot>
                            </table>
                        }

                        ---

                        @{ // Calcular tpenalizacion *antes* de la condición del if
                            foreach (var rs in Model.Cedula.respuestas)
                            {
                                if (rs.MontoPenalizacion != 0 && rs.cuestionario.Tipo != null && rs.cuestionario.Tipo.Equals("Penalizacion"))
                                {
                                    tpenalizacion += (decimal)rs.MontoPenalizacion;
                                }
                            }
                        }

                        @if (tpenalizacion != 0) // Ahora condicionamos la aparición de la tabla con el total calculado
                        {
                            <h5 class="mt-4 text-center text-danger">Penalizaciones Aplicadas</h5>
                            <table class="table table-hover table-bordered dataTable" width="100%">
                                <thead>
                                    <tr>
                                        <th class="text-center">Pregunta</th>
                                        <th class="text-center">Tipo</th>
                                        <th class="text-center">Concepto</th>
                                        <th class="text-right">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var rs in Model.Cedula.respuestas)
                                    {
                                        // La condición interna sigue siendo necesaria para filtrar las filas individuales
                                        if (rs.Penalizable == true && rs.cuestionario.Tipo != null && rs.cuestionario.Tipo.Equals("Penalizacion"))
                                        {
                                            <tr>
                                                <td class="text-center">@rs.Pregunta</td>
                                                <td class="text-center">Penalización</td>
                                                <td class="text-center">@Html.Raw(rs.cuestionario.Icono) @rs.cuestionario.Concepto</td>
                                                <td class="text-right-lg font-weight-bold">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @rs.MontoPenalizacion)</td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                                <tfoot>
                                    <tr class="font-weight-bold text-danger bg-light">
                                        <td colspan="3" class="text-right-lg">Total de Penalizaciones sin I.V.A.</td>
                                        <td class="text-right-lg">@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", tpenalizacion)</td>
                                    </tr>
                                </tfoot>
                            </table>}

                    </div>
                </div>
            </div>
        </div>
    }

    @if (Model.Soporte.Count() > 0)
    {
        <div class="row col-lg-12 mt-3" id="divGuiasNoEntregadas">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header text-danger cabeceraGuiasNE">
                        <i class="fa-sharp fa-regular fa-circle-pause mr-2"></i> @Model.Soporte.Count() Guías Pendientes
                    </div>
                    <div class="card-body cuerpoGuiasNE" style="display: none">
                        <table class="table dataTable" id="tblGuias" width="100%">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Número de guía</th>
                                    <th>Fecha recolección</th>
                                    <th>Fecha de entrega</th>
                                    <th>¿Tiene acuse?</th>
                                    <th>Monto Servicio</th>
                                    <th>Monto Sobrepeso</th>
                                    <th>Monto Acuse</th>
                                    <th>Fecha Creacion</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var sop in Model.Soporte)
                                {
                                    sp++;
                                    <tr>
                                        <td>@sp</td>
                                        <td>@sop.NumeroGuia</td>
                                        <td>@Convert.ToDateTime(sop.FechaRecoleccion).ToString("dd/MM/yyyy")</td>
                                        <td>@(Convert.ToDateTime(sop.FechaEntrega).ToString("dd/MM/yyyy").Equals("01/01/1990") ? "Sin fecha de entrega": Convert.ToDateTime(sop.FechaEntrega).ToString("dd/MM/yyyy"))</td>
                                        <td class="text-center">@sop.Acuse</td>
                                        <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @sop.MontoServicio)</td>
                                        <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @sop.MontoSobrepeso)</td>
                                        <td>@String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", @sop.MontoAcuse)</td>
                                        <td>@Convert.ToDateTime(sop.FechaCreacion).ToString("dd/MM/yyyy hh:mm tt")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="row col-lg-12 mt-3" id="divHistorialCedula">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header cabeceraSegCedula">
                    <i class="fal fa-timeline-arrow mr-2"></i> Seguimiento a la cédula
                </div>
                <div class="card-body cuerpoSegCedula" style="display: none">
                    <table class="table dataTable tblLogCedula" width="100%">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Usuario</th>
                                <th>Estatus</th>
                                <th>Comentarios</th>
                                <th>Última actualización</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var lg in Model.Cedula.logs)
                            {
                                lc++;
                                <tr>
                                    <td>@lc</td>
                                    <td>@(System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase((lg.Usuario.NombreEmp + " " + lg.Usuario.PaternoEmp + " " + lg.Usuario.MaternoEmp).ToLower()))</td>
                                    <td style="color: @(lg.Estatus.FondoHexadecimal); font-weight: bold;">@lg.Estatus.Nombre</td>
                                    <td>@Html.Raw(lg.Observaciones)</td>
                                    <td>@Convert.ToDateTime(lg.FechaCreacion).ToString("dd/MM/yyyy hh:mm tt")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row col-lg-12 mt-3" id="divHistorialEntregables">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header cabeceraSegEntregables">
                    <i class="fa-light fa-timeline mr-2"></i> Seguimiento a entregables
                </div>
                <div class="card-body cuerpoSegEntregables" style="display: none">
                    <table class="table dataTable tblLogEntregables" width="100%">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Usuario</th>
                                <th>Archivo</th>
                                <th>Estatus</th>
                                <th>Comentarios</th>
                                <th>Última actualización</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{ lc = 0;}
                            @foreach (var lg in Model.Cedula.logsEntregables)
                            {
                                lc++;
                                <tr>
                                    <td>@lc</td>
                                    <td>@(System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase((lg.Usuario.NombreEmp + " " + lg.Usuario.PaternoEmp + " " + lg.Usuario.MaternoEmp).ToLower()))</td>
                                    <td>@lg.Entregable.Nombre</td>
                                    <td style="color: @(lg.Estatus.FondoHexadecimal); font-weight: bold;">@lg.Estatus.Nombre</td>
                                    <td>@Html.Raw(lg.Observaciones)</td>
                                    <td>@Convert.ToDateTime(lg.FechaCreacion).ToString("dd/MM/yyyy hh:mm tt")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

@* Modal para la captura de la Factura *@
<div class="modal fade" id="modalXML">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white">Adjuntar XML</h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="height: 200px;">
                <div class="row">
                    <div class="form-group col-lg-4">
                        <label>Tipo de XML</label>
                        <select class="form-control" id="TipoDocumentacion">
                            <option value="">Seleccione la Documentación</option>
                            <option value="Factura">Factura</option>
                            <option value="NC">Nota de Crédito</option>
                        </select>
                        <div class="col-sm-12" id="error_TipoDocumentacion">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione el tipo de documentación
                            </small>
                        </div>
                    </div>
                    <div class="form-group col-lg-6">
                        <label for="elegirArchivo">Seleccionar Archivo XML: </label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="fileXML" accept=".xml, .XML" asp-for="XML">
                            <label class="custom-file-label" for="customFile">Seleccionar Archivo</label>
                        </div>
                        <div class="col-sm-12" id="error_fileXML">
                            <small id="dateHelp" class="text-danger">
                                No ha seleccionado el archivo XML o ha subido un archivo diferente a XML
                            </small>
                        </div>
                    </div>
                    <div class="form-group col-lg-6">
                        <label for="elegirArchivo">Seleccionar Archivo PDF: </label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="filePDF" accept=".pdf, .PDF">
                            <label class="custom-file-label custom-pdf" for="customFile">Seleccionar Archivo</label>
                        </div>
                        <div class="col-sm-12" id="error_filePDF">
                            <small id="dateHelp" class="text-danger">
                                No ha seleccionado el archivo PDF o ha subido un archivo diferente a PDF
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="submit" class="btn btn-primary" id="adjuntarArchivo">Subir</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para la captura de la Factura*@

@* Modal para la captura de Incidencias *@
<div class="modal fade" id="modal-incidencias">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white titleAddI"></h4>
                <button type="button" class="close close-incidencias text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row col-lg-12">
                    <input type="hidden" id="campoIdIncidencia" />
                    <input type="hidden" id="campoIncidenciaId" />
                    <input type="hidden" id="campoPregunta" />
                    <input type="hidden" id="campoPreguntaId" />
                    <div class="form-group col-md-3" id="divFechaProgramada">
                        <label for="fechaProgramada">Fecha Programada: </label>
                        <input type="date" class="form-control" id="campoFechaProgramada" name="fechaProgramada">
                        <div class="col-sm-12" id="error_campoFechaProgramada">
                            <small id="dateHelp" class="text-danger">
                                Capture la fecha programada
                            </small>
                        </div>
                    </div>
                    <div class="form-group col-md-3" id="divFechaEntrega">
                        <label for="fechaEntrega">Fecha Entrega: </label>
                        <input type="date" class="form-control" id="campoFechaEntrega" name="fechaEntrega">
                        <div class="col-sm-12" id="error_campoFechaEntrega">
                            <small id="dateHelp" class="text-danger">
                                Capture la fecha de entrega
                            </small>
                        </div>
                    </div>
                    <div class="col-lg-3" id="divNumeroGuia">
                        <label for="numeroGuia">Número de Guía:</label>
                        <input class="form-control" id="campoNumeroGuia" maxlength="22" />
                        <div class="col-sm-12" id="error_campoNumeroGuia">
                            <small id="dateHelp" class="text-danger">
                                Capture el número de guía
                            </small>
                        </div>
                    </div>
                    <div class="col-lg-3" id="divCodigoRastreo">
                        <label for="codigoRastreo">Código de Rastreo:</label>
                        <input class="form-control" id="campoCodigoRastreo" maxlength="10" />
                        <div class="col-sm-12" id="error_campoCodigoRastreo">
                            <small id="dateHelp" class="text-danger">
                                Capture el código de rastreo
                            </small>
                        </div>
                    </div>
                    <div class="col-lg-3" id="divTieneAcuse">
                        <label for="acuse">¿Tiene Acuse?:</label>
                        <select class="form-control" id="campoAcuses">
                            <option value="">Seleccione una opción</option>
                            <option value="SI">SI</option>
                            <option value="NO">NO</option>
                        </select>
                        <div class="col-sm-12" id="error_campoAcuses">
                            <small id="dateHelp" class="text-danger">
                                Seleccione si tuvo acuse la guía
                            </small>
                        </div>
                    </div>
                    <div class="col col-lg-2" id="divTotalAcuses">
                        <label for="totalAcuses">Total de Acuses:</label>
                        <input class="form-control" id="campoTotalAcuses" />
                        <div class="col-sm-12" id="error_campoTotalAcuses">
                            <small id="dateHelp" class="text-danger">
                                Capture el total de acuses
                            </small>
                        </div>
                    </div>
                    <div class="col col-lg-3" id="divTipoServicio">
                        <label for="tipoServicio">Tipo de Servicio:</label>
                        <select class="form-control" id="campoTipoServicio">
                            <option value="">Seleccione una opción</option>
                            <option value="Nacional">Nacional</option>
                            <option value="Internacional">Internacional</option>
                            <option value="Nacional Sobrepeso">Nacional Sobrepeso</option>
                            <option value="Internacional Sobrepeso">Internacional Sobrepeso</option>
                        </select>
                        <div class="col-sm-12" id="error_campoTipoServicio">
                            <small id="dateHelp" class="text-danger">
                                Seleccione el tipo de Servicio.
                            </small>
                        </div>
                    </div>
                    <div class="col col-lg-3" id="divTipoIndemnizacion">
                        <label for="tipoServicio">Tipo de Contenido: </label>
                        <a href="javascript:" class="text-primary ml-2 abreInfo" data-toggle="tooltip" title="Ayuda" data-placement="top">
                            <i class="fa-solid fa-circle-question"></i>
                        </a>

                        <select class="form-control" id="campoTipoIndemnizacion">
                        </select>

                        <div class="col-sm-12" id="error_campoTipoIndemnizacion">
                            <small id="dateHelp" class="text-danger">
                                Seleccione el tipo de Contenido.
                            </small>
                        </div>
                    </div>

                    <div class="form-group col-lg-2" id="divSobrepeso">
                        <label for="sobrepeso">Peso Real (Kg)</label>
                        <input class="form-control" id="campoSobrepeso" type="number" min="1" max="100" />
                        <div class="col-sm-12" id="error_campoSobrepeso">
                            <small id="dateHelp" class="text-danger">
                                Por favor capture el sobrepeso de la guía
                            </small>
                        </div>
                    </div>
                </div>
                <div class="row col-lg-12" id="divDetallesIncidencia">
                    <div class="form-row col-lg-12">

                    </div>
                </div>
                <div class="row col-lg-12 mt-3">
                    <div class="form-group col-lg-6" id="divArchivoActa">
                        <label for="tieneAcuse">Adjuntar acta del incidente</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input actaRE" id="fileActa" accept=".pdf,.PDF">
                            <label class="custom-file-label nameActaRE" for="customFile">Seleccionar Archivo</label>
                        </div>
                        <div class="col-sm-12" id="error_archivoActa">
                            <small id="dateHelp" class="text-danger">
                                Por favor cargue el acta correspondiente
                            </small>
                        </div>
                    </div>
                    <div class="form-group col-lg-6" id="divArchivoEscrito">
                        <label for="tieneAcuse">Adjuntar escrito del robo/extravío</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="fileEscrito" accept=".pdf,.PDF">
                            <label class="custom-file-label archivoEscrito" for="nameEscrito">Seleccionar Archivo</label>
                        </div>
                        <div class="col-sm-12" id="error_archivoEscrito">
                            <small id="dateHelp" class="text-danger">
                                Por favor cargue el escrito del "Robo/Extravío"
                            </small>
                        </div>
                    </div>
                    <div class="form-group col-lg-6" id="divArchivoComprobante">
                        <label for="tieneAcuse">Adjuntar comprobante de entrega</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="fileComprobante" accept=".pdf,.PDF">
                            <label class="custom-file-label archivoComprobante" for="nameComprobante">Seleccionar Archivo</label>
                        </div>
                        <div class="col-sm-12" id="error_archivoComprobante">
                            <small id="dateHelp" class="text-danger">
                                Por favor cargue el escrito del "Comprobante de Entrega"
                            </small>
                        </div>
                    </div>
                </div>
                <div class="row col-lg-12 mt-2" id="divObservaciones">
                    <div class="form-group col-lg-12">
                        <label for="campoObservaciones">Observaciones:</label>
                        <a href="javascript:" class="text-primary ml-2 btnAyudaI" data-toggle="tooltip" title="Ayuda" data-placement="top">
                            <i class="fa-solid fa-circle-question"></i>
                        </a>
                        <textarea type="textarea" id="campoObservaciones" class="form-control" style="resize: none;" maxlength="256"></textarea>
                        <div class="col-sm-12" id="error_observaciones">
                            <small id="dateHelp" class="text-danger">
                                Por favor capture las observaciones
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="guardaIncidencia">Guardar Incidencia</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@* Modal para la captura de Incidencias *@


@* MODAL COMO NOTA INFORMATIVA PREGUNTA 5 Y 6 TIPO DE CONTENIDO   *@
<div class="modal fade" id="modal-avisoPreg5y6">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white"> <b></b>📢 INFORMACIÓN IMPORTANTE - TIPO DE CONTENIDO</h4>

            </div>
            <div class="modal-body">
                <p>
                    <B>Deberá registrar los detalles de la guía extraviada, asegurando que el "Tipo de Contenido" coincida con los documentos (Acta y Escrito) proporcionados por el prestador de servicios:</B>
                </p>
                <p>1. <B>Jurisdiccional</B>: Documentación oficial en donde se manejan tiempos perentorios y plazos en la impartición de justicia, para el trámite de los procesos judiciales. </p>
                <p>2. <B>Expediente</B>: Cuando el contenido son expedientes.  </p>
                <p>3. <B>Administrativo</B>: Documentación oficial de tipo administrativo, y que no conlleva tiempos perentorios. </p>
                <p>4. <B>Bienes</B>: Cuando el contenido son bienes muebles y bienes de consumo.  </p>
                <p>5. <B>Otros</B>: Cuando el contenido no es ninguno de los anteriores, y/o el área remitente no proporcionó información. </p>


                <p>Cabe aclarar que el tipo de contenido se debió verificar con el área que remitió la guía (órgano jurisdiccional, etc.).</p>
                <div class="modal-footer">
                    <button type="button" class="btn-danger close-incidencias2 text-white" data-dismiss="modal" aria-label="Close">CERRAR</button>
                </div>
            </div>
        </div>
    </div>
</div>
@* FIN DE MODAL NOTA INFORMATIVA PREGUNTA 5 Y 6 TIPO DE CONTENIDO *@



@* Modal para la captura de Incidencias Excel *@
<div class="modal fade" id="modal-incidencias-excel">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white titleAddI"></h4>
                <button type="button" class="close close-incidencias text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row col-lg-12">
                    <input type="hidden" id="campoIdIncidencia" />
                    <input type="hidden" id="campoIncidenciaId" />
                    <input type="hidden" id="campoPregunta" />
                    <input type="hidden" id="campoPreguntaId" />
                </div>
                <div class="row col-lg-12">
                    <div class="form-row col-lg-12">
                        <div class="form-group col-lg-6" id="divArchivoExcel">
                            <label for="tieneAcuse">Adjuntar archivo de incidencias</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input incidenciasExcel" id="fileExcel" accept=".xlsx,.XLSX">
                                <label class="custom-file-label nameExcel" for="customExcel">Seleccionar Archivo</label>
                            </div>
                            <div class="col-sm-12" id="error_archivoExcel">
                                <small id="dateHelp" class="text-danger">
                                    Por favor cargue el archivo de excel correspondiente
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="guardaExcel">Importar</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@* Modal para la captura de Incidencias Excel *@


@* MODAL PREGUNTA 2: AVISO QUE EL EXCEL DEBE INCLUIR "NACIONAL SOBREPESO" EN LAS GUÍAS CUYO PESO SEA > 0 *@
<div class="modal fade" id="modal-avisoPreg2" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h4 class="modal-title"><strong><i class="fas fa-exclamation-triangle"></i> ¡ALERTA! Formato de Tipo de Servicio</strong></h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>
                    <strong>¡IMPORTANTE!</strong> Para las guías con SOBREPESO, es obligatorio especificar el tipo de servicio en la columna "Tipo de Servicio" de su plantilla de incidencias.
                </p>
                <p><strong><span class="text-danger">"Nacional Sobrepeso"</span></strong> o <strong><span class="text-danger">"Internacional Sobrepeso"</span></strong></p>
                <img src="~/img/Pregunta2MENS.png" class="img-fluid" alt="Imagen de ejemplo">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Entendido</button>
            </div>
        </div>
    </div>
</div>
@* MODAL PREGUNTA 2: AVISO QUE EL EXCEL DEBE INCLUIR "NACIONAL SOBREPESO" EN LAS GUÍAS CUYO PESO SEA > 0 *@


@* Modal para la captura de los entregables *@
<div class="modal fade" id="modalEntregables">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white tituloEntregable"></h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="campoIdEntregable" />
                <input type="hidden" id="campoTipoEntregable" />
                <input type="hidden" id="campoentregableid" />
                <div class="form-group col-lg-12">
                    <p id="notaEntregable"></p>
                </div>
                <div class="form-group col-lg-8">
                    <label for="elegirArchivo">Seleccionar Archivo PDF: </label>
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="entregablePDF" accept=".pdf, .PDF">
                        <label class="custom-file-label custom-pdf" for="customFile">Seleccionar Archivo</label>
                    </div>
                    <div class="col-sm-12" id="error_entregablePDF">
                        <small id="dateHelp" class="text-danger">
                            No ha seleccionado el archivo PDF o ha subido un archivo diferente a PDF
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="submit" class="btn btn-primary" id="guardarEntregable">Adjuntar</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para la captura de los entregables *@

@*Modal para ver los Entregables*@
<div class="modal fade" id="modalVerEntregables">
    <div class="modal-dialog modal-xl-view">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white" id="titleVerEntregables"></h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body-view">
                <div class="row col-lg-12" id="detalleEntregable"></div>
                <div class="table-responsive">
                    <div class="row mb-2 col-lg-12" id="objectPdf">
                    </div>
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para ver los Entregables*@

@*Modal para ver la factura*@
<div class="modal fade" id="modalVerEntregableFactura">
    <div class="modal-dialog modal-xl-view">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white" id="titleVerEntregables"></h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body-view">
                <div class="row col-lg-12" id="detalleEntregable"></div>
                <div class="table-responsive">
                    <div class="row mb-2 col-lg-12" id="objectPdf">
                    </div>
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para ver la factura*@


<style>
    .text-right-lg {
        text-align: right;
        font-size: 1.3em;
    }
    #modal-avisoPreg2 .modal-content {
        border: 2px solid red;
        border-radius: 10px;
    }

    #modal-avisoPreg2 .modal-header {
        background-color: #dc3545; /* Rojo de Bootstrap */
        color: white;
        border-bottom: 1px solid #b02a37;
    }

    #modal-avisoPreg2 .modal-title {
        font-size: 1.2rem;
        font-weight: bold;
    }

    #modal-avisoPreg2 .modal-body {
        padding: 20px;
        font-size: 1rem;
        line-height: 1.5;
    }

    #modal-avisoPreg2 .modal-footer {
        border-top: 1px solid #b02a37;
        padding: 15px;
        text-align: right;
    }

    #modal-avisoPreg2 .btn-danger {
        background-color: #dc3545; /* Rojo de Bootstrap */
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 1rem;
    }

        #modal-avisoPreg2 .btn-danger:hover {
            background-color: #c82333;
        }

    #modal-avisoPreg2 .text-danger {
        color: #dc3545;
    }
    #modal1 {
        position: fixed;
        z-index: 1000;
        /* otros estilos */
    }

    .titulo-principal {
        font-family: Arial, sans-serif;
        font-size: 20px;
        color: #24135f;
        text-align: left;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        animation: fadeIn 2s ease-in-out;
        font-weight: bold;
        position: relative; /* Agrega esta línea */
        top: -5px; /* Ajusta el valor según sea necesario */
        right: -10px;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .botonregreso {
        position: relative; /* Agrega esta línea */
        left: -33px;
    }

    .cabeceraInformacion {
        background-color: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    .cabeceraInformacionG {
        background-color: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    .cabeceraContrato {
        background-color: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    .cabeceraInmueble {
        background-color: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    .cabeceraFacturacion {
        background-color: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    .cabeceraCedula {
        background-color: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    .cabeceraEntregables {
        background-color: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    .cabeceraPenalizaciones {
        background-color: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    .cabeceraGuiasNE {
        background-color: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    .cabeceraSegCedula {
        background-color: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    .cabeceraSegEntregables {
        background-color: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    td table tr:first-child td {
        border-top: none !important;
        padding-top: 0 !important;
    }

    .swal-wide {
        width: 800px !important;
    }

    .close-incidencias2 {
        transform: translate(-420%, 0%);
        background-color: #FF0000; /* Cambia el color de fondo a rojo */
        color: #fff; /* Mantiene el texto blanco */
        border: none; /* Elimina el borde por defecto */
        border-radius: 5px; /* Añade esquinas redondeadas */
        padding: 10px 20px; /* Ajusta el padding para un botón más grande */
        font-size: 16px; /* Aumenta el tamaño de la fuente */
    }

    .large-swal-popup {
        width: 60em !important; /* Mantén el ancho o ajústalo si es necesario */
        font-size: 1.5em !important; /* ¡AJUSTA ESTE VALOR PARA HACER EL TEXTO MÁS GRANDE! */
        /* Puedes probar con 1.4em, 1.6em, 1.8em, etc. */
    }

    /* El difuminado del fondo sigue siendo el mismo */
    .swal2-backdrop-show {
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
    }
</style>

@*Modal para actualizar firmantes*@
<div class="modal fade" id="modal-firmante">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white">Capturar Firmantes</h4>
                <button type="button" class="close close-incidencias text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <input type="hidden" id="idFirmante" />
                    <div class="row col-lg-12 font-weight-bold">
                        <h4>Revisó: </h4>
                        <br />
                    </div>
                    <div class="form-row col-md-4" id="divInmuebleReviso">
                        <label for="firmanteActual">Inmueble:</label>
                        <select class="form-control inmuebleReviso" disabled>
                            <option value="">Seleccione un Inmueble</option>
                            @foreach (var inm in Model.InmueblesFirmantes)
                            {
                                <option value="@inm.Id">@inm.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="form-row col-md-3" id="divEscolaridadA">
                        <label for="firmanteActual">Escolaridad:</label>
                        <select class="form-control" id="escolaridadReviso">
                            <option value="">Seleccione una escolaridad</option>
                            <option value="C.">Ciudadano</option>
                            <option value="Lic.">Licenciatura</option>
                            <option value="Ing.">Ingeniería</option>
                            <option value="C.P.">Contaduría</option>
                            <option value="Arq.">Arquitectura</option>
                            <option value="Act.">Actuaría</option>
                            <option value="Mtro.">Maestro</option>
                            <option value="Mtra.">Maestra</option>
                            <option value="Dr.">Doctor</option>
                            <option value="Dra.">Doctora</option>
                        </select>
                        <div class="col-sm-12" id="error_escolaridadReviso">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione el firmante que revisa.
                            </small>
                        </div>
                    </div>
                    <div class="form-row col-md-4" id="divFirmante">
                        <label for="firmanteActual">Firmante:</label>
                        <select class="form-control" id="firmanteReviso">
                            <option value="">Seleccione un servidor público</option>
                            @foreach (var us in Model.Usuarios)
                            {
                                <option value="@us.Id">@us.NombreEmp @us.PaternoEmp @us.MaternoEmp</option>
                            }
                        </select>
                        <div class="col-sm-12" id="error_firmanteReviso">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione la escolaridad del firmante que revisa.
                            </small>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="row col-lg-12 font-weight-bold">
                        <h4>Supervisó: </h4>
                        <br />
                    </div>
                    <div class="form-row col-md-4" id="divEscolaridadA">
                        <label for="firmanteActual">Inmueble:</label>
                        <select class="form-control inmuebleSuperviso" disabled>
                            <option value="">Seleccione un Inmueble</option>
                            @foreach (var inm in Model.InmueblesFirmantes)
                            {
                                <option value="@inm.Id">@inm.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="form-row col-md-3" id="divEscolaridadN">
                        <label for="firmanteActual">Escolaridad:</label>
                        <select class="form-control" id="escolaridadSuperviso">
                            <option value="">Seleccione una escolaridad</option>
                            <option value="C.">Ciudadano</option>
                            <option value="Lic.">Licenciatura</option>
                            <option value="Ing.">Ingeniería</option>
                            <option value="C.P.">Contaduría</option>
                            <option value="Arq.">Arquitectura</option>
                            <option value="Act.">Actuaría</option>
                            <option value="Mtro.">Maestro</option>
                            <option value="Mtra.">Maestra</option>
                            <option value="Dr.">Doctor</option>
                            <option value="Dra.">Doctora</option>
                        </select>
                        <div class="col-sm-12" id="error_escolaridadSuperviso">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione la escolaridad del firmante que supervisa.
                            </small>
                        </div>
                    </div>
                    <div class="form-row col-md-4" id="divFirmante">
                        <div class="select2-purple col-lg-12">
                            <label for="firmanteActual">Firmante:</label>
                            <select class="form-control select2bs4" data-dropdown-css-class="select2-purple" id="firmanteSuperviso">
                                <option value="">Seleccione un servidor público</option>
                                @foreach (var us in Model.Usuarios)
                                {
                                    <option value="@us.Id">@us.NombreEmp @us.PaternoEmp @us.MaternoEmp</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-12" id="error_firmanteSuperviso">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione el firmante que supervisa.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-primary" id="actualizarFirmante">Guardar Firmantes</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin del Modal para Capturar Oficios*@


@section Scripts{
    <script>
        $(function () {
            $('#error_filePDF').css('display', 'none');
            $('#error_fileXML').css('display', 'none');
            $('#error_TipoDocumentacion').css('display', 'none');
            $('#error_entregablePDF').css('display', 'none');

            $("#error_escolaridadReviso").css("display", "none");
            $("#error_firmanteReviso").css("display", "none");
            $("#error_escolaridadSuperviso").css("display", "none");
            $("#error_firmanteSuperviso").css("display", "none");

            $('[data-toggle="tooltip"]').tooltip();
            $(".conceptosFactura").css("display", "none");

            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                var target = $(e.target).attr("href") // activated tab
                localStorage.setItem('activeTab', target);
            });

            $(".select2").select2();

            $('.select2bs4').select2({
                theme: 'bootstrap4'
            });

            localStorage.getItem('activeTab')

            if (localStorage.getItem('activeTab')) {
                var idTab = localStorage.getItem('activeTab').replace("#", "");
                $('#myTab li:first').removeClass('active');
                $('a[href="' + localStorage.getItem('activeTab') + '"]').addClass('active');
                $('#myTab li:first').removeClass("show active");
                $("#" + idTab).addClass("show active");
            }

            $(".btnXML").click(function () {
                $("#modalXML").modal('show');
            });

            $(".cabeceraInformacionG").click(function () {
                $header = $(this);
                $content = $header.next();
                $content.slideToggle(500, function () {
                });
            });

            $(".cabeceraInformacion").click(function () {
                $header = $(this);
                $content = $header.next();
                $content.slideToggle(500, function () {
                });
            });

            $(".cabeceraContrato").click(function () {
                $header = $(this);
                $content = $header.next();
                $content.slideToggle(500, function () {
                });
            });

            $(".cabeceraInmueble").click(function () {
                $header = $(this);
                $content = $header.next();
                $content.slideToggle(500, function () {
                });
            });

            $(".cabeceraFacturacion").click(function () {
                $header = $(this);
                $content = $header.next();
                $content.slideToggle(500, function () {
                });
            });

            $(".cabeceraCedula").click(function () {
                $header = $(this);
                $content = $header.next();
                $content.slideToggle(500, function () {
                });
            });

            $(".cabeceraEntregables").click(function () {
                $header = $(this);
                $content = $header.next();
                $content.slideToggle(500, function () {
                });
            });

            $(".cabeceraPenalizaciones").click(function () {
                $header = $(this);
                $content = $header.next();
                $content.slideToggle(500, function () {
                });
            });

            $(".cabeceraGuiasNE").click(function () {
                $header = $(this);
                $content = $header.next();
                $content.slideToggle(500, function () {
                });
            });

            $(".cabeceraSegCedula").click(function () {
                $header = $(this);
                $content = $header.next();
                $content.slideToggle(500, function () {
                });
            });

            $(".cabeceraSegEntregables").click(function () {
                $header = $(this);
                $content = $header.next();
                $content.slideToggle(500, function () {
                });
            });

            $('.viewConceptosF').click(function () {
                let factura = $(this).data('factura');
                if ($("#conceptoFactura_" + factura).css('display') == 'none') {
                    $("#conceptoFactura_" + factura).css("display", "block");
                }
                else {
                    $("#conceptoFactura_" + factura).css("display", "none");
                }
            });

            $(".viewConceptosF").click(function () {
                if ($("#viewConceptos_" + $(this).data('factura') + " > i").hasClass("text-success")) {
                    $("#viewConceptos_" + $(this).data('factura') + " > i").removeClass("text-success");
                    $("#viewConceptos_" + $(this).data('factura') + "> i").addClass("text-danger");
                } else {
                    $("#viewConceptos_" + $(this).data('factura') + " > i").removeClass("text-danger");
                    $("#viewConceptos_" + $(this).data('factura') + " > i").addClass("text-success");
                }
            });

            /*********************************** Apartado de Evaluación **********************************/

            const modulo = @Html.Raw(Json.Serialize(@Model.Modulo));
            const supervision = @Html.Raw(Json.Serialize(@Model.Supervision));
            const submodulo = @Html.Raw(Json.Serialize(@Model.Submodulo));
            const inmueble = @Html.Raw(Json.Serialize(@Model.Inmueble));
            const respuestas = @Html.Raw(Json.Serialize(@Model.Cedula.respuestas));
            const preguntasDeductiva = @Html.Raw(Json.Serialize(@pDeductivas));
            const penasDeductivas = @Html.Raw(Json.Serialize(@Model.Cedula.respuestas.Where(r => pDeductivas.Contains(r.Pregunta)).Sum(m => m.MontoPenalizacion)));
            const facturas = @Html.Raw(Json.Serialize(@Model.Facturas));
            const repositorio = @Html.Raw(Json.Serialize(@Model.Repositorio.Id));
            const existsNC = @Html.Raw(Json.Serialize(@Model.Facturas.Where(f => f.Tipo.Equals("NC")).Count()));
            const cedula = @Html.Raw(Json.Serialize(@Model.Cedula));
            const configuracion = @Html.Raw(Json.Serialize(@Model.ConfiguracionIncidencias));
            const entregables = @Html.Raw(Json.Serialize(@Model.Cedula.entregables));
            const soporte = @Html.Raw(Json.Serialize(@Model.Soporte));
            const rechazarTramite = @Html.Raw(Json.Serialize(@Model.Cedula.entregables.Where(e=> e.estatus.Nombre.Equals("Rechazado")).Count()));
            const usuario = @Html.Raw(Json.Serialize(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier).Value));

            if (rechazarTramite == 0)
            {
                $(".tramiteRechazado").remove();
            }
            else
            {
                $(".autorizarCAE").remove();
                $(".tramitePago").remove();
            }

            $(".tblIncidencias").DataTable({
                dom: 'lBfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        title: 'Listado de Soporte de Pago',
                        className: "bg-cjf mr-1",
                    },
                    {
                        extend: 'pdfHtml5',
                        title: 'Listado de Soporte de Pago',
                        className: "bg-cjf mr-1",
                        orientation: "landscape"
                    },
                    {
                        extend: 'print',
                        title: 'Listado de Soporte de Pago',
                        text: 'Imprimir',
                        className: "bg-cjf mr-1"
                    }
                ],
                lengthMenu: [[25,40, 90, -1], [25, 40, 90, "Todos"]],
                responsive: true,
                stateSave: true,
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
                },
            });

            $(".tblLogCedula").DataTable({
                responsive: true,
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
                },
            });

            $(".tblLogEntregables").DataTable({
                responsive: true,
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
                },
            });

            $('#tblGuias').DataTable({
                dom: 'lBfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        title: 'Listado de Soporte de Pago',
                        className: "bg-cjf mr-1",
                    },
                    {
                        extend: 'pdfHtml5',
                        title: 'Listado de Soporte de Pago',
                        className: "bg-cjf mr-1",
                        orientation: "landscape"
                    },
                    {
                        extend: 'print',
                        title: 'Listado de Soporte de Pago',
                        text: 'Imprimir',
                        className: "bg-cjf mr-1"
                    }
                ],
                lengthMenu: [[15, 25, 50, -1], [15, 25, 50, "Todos"]],
                responsive: true,
                stateSave: true,
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
                },
            });

            for (var i = 0; i < respuestas.length; i++) {
                if (respuestas[i].detalles == "N/A")
                {
                    $('input:radio[name="' + respuestas[i].cuestionario.abreviacion + '"][value="'+respuestas[i].detalles+'"]').prop('checked', true);
                }
                else
                {
                    $('input:radio[name="' + respuestas[i].cuestionario.abreviacion + '"][value="' + respuestas[i].respuesta + '"]').prop('checked', true);
                }
            }

            if (cedula.estatus.nombre == "Revisión CAE" || cedula.estatus.nombre == "Autorizado CAE" || cedula.estatus.nombre == "En Trámite"
            || cedula.estatus.nombre == "Trámite de Pago" || cedula.estatus.nombre == "Trámite Rechazado") {
                $(".cuerpoCedula").css("display", "none");
                $(".cuerpoEntregables").css("display", "block");
            }
            else if (cedula.estatus.nombre == "Sin Iniciar" || cedula.estatus.nombre == "En Proceso" || cedula.estatus.nombre == "Rechazada")
            {
                $(".cuerpoCedula").css("display", "block");
                $(".cuerpoEntregables").css("display", "block");
            }
            else if (cedula.estatus.nombre == "Autorizada")
            {
                $(".cuerpoCedula").css("display", "block");
                $(".cuerpoEntregables").css("display", "block");
                $(".cuerpoPenalizaciones").css("display", "block");
            }


            /*********************************** Apartado de Evaluación **********************************/

            /*********************************** Apartado de Incidencias **********************************/
            $(".addIncidencia").click(function () {
                limpiaCampos();
                if ($(this).data('respuesta') == null || $(this).data('respuesta') == "")
                {
                    Swal.fire({
                        icon: 'error',
                        title: 'Servicio de Mensajería Acelerada',
                        html: 'Por favor seleccione una respuesta antes de capturar incidencias u observaciones.'
                    });
                }
                else
                {
                    $(".titleAddI").text("Registrar Incidencia - "+$(this).data("titulo"));
                    ocultaCamposIncidencia();
                    muestraCamposIncidencia($(this).data("preguntaid"), $(this).data("abreviacion"));
                    $(".btnAyudaI").attr('data-ayuda', $(this).data('ayuda'));
                    $("#campoPregunta").val($(this).data("pregunta"));
                    $("#campoPreguntaId").val($(this).data("preguntaid"));
                    $("#campoIncidencia").val($(this).data("abreviacion"));
                    $("#campoIncidenciaId").val($(this).data("incidenciaid"));
                    axios.get('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?Incidencia=' + $(this).data("incidenciaid") +'&handler=IndemnizacionByIncidencia').then(response => {
                                if (response.status == 200)
                                {
                                    //******** SE MODIFICÓ EL ORDEN DE APARICIÓN DE LAS OPCIONES EN TIPO DE CONTENIDO *******
                                    var options = '<option value="0">Seleccione una opción</option>';
                                    options += '<option value="' + response.data[4].id + '">' + response.data[4].nombre + '</option>'
                                    options += '<option value="' + response.data[2].id + '">' + response.data[2].nombre + '</option>'
                                    options += '<option value="' + response.data[1].id + '">' + response.data[1].nombre + '</option>'
                                    options += '<option value="' + response.data[0].id + '">' + response.data[0].nombre + '</option>'
                                    options += '<option value="' + response.data[3].id + '">' + response.data[3].nombre + '</option>'

                                    $("#campoTipoIndemnizacion").html(options);

                                    //for (var i = 0; i < response.data.length; i++) {
                                    //    options += '<option value="' + response.data[i].id + '">' + response.data[i].nombre + '</option>'
                                    //}
                                    //$("#campoTipoIndemnizacion").html(options);
                                }
                            });
                    $("#modal-incidencias").modal("show");
                }
                if ($(this).data('pregunta') == 5 || $(this).data('pregunta') == 6)
                {
                    $("#modal-avisoPreg5y6").modal("show");
                }
            });

            $(".abreInfo").click(function () {
                $("#modal-avisoPreg5y6").modal("show");

            });

            $(".addIncidenciaExcel").click(function () {
                limpiaCampos();

                if ($(this).data('respuesta') == null || $(this).data('respuesta') == "")
                {
                    Swal.fire({
                        icon: 'error',
                        title: 'Servicio de Mensajería Acelerada',
                        html: 'Por favor seleccione una respuesta antes de capturar incidencias u observaciones.'
                    });
                }
                else
                {
                    $(".titleAddI").text("Importar Incidencias - "+$(this).data("titulo"));
                    ocultaCamposIncidencia();
                    $("#error_archivoExcel").css("display", "none");
                    $("#campoPregunta").val($(this).data("pregunta"));
                    $("#campoPreguntaId").val($(this).data("preguntaid"));
                    $("#campoIncidencia").val($(this).data("abreviacion"));
                    $("#campoIncidenciaId").val($(this).data("incidenciaid"));
                    $("#modal-incidencias-excel").modal("show");
                }
                $("#modal-avisoPreg2").modal("show");
            });

            function limpiaCampos()
            {
                $("#campoIdIncidencia").val("");
                $("#campoIncidenciaId").val("");
                $("#campoPregunta").val("");
                $("#campoPreguntaId").val("");
                $("#campoFechaProgramada").val("");
                $("#campoFechaEntrega").val("");
                $("#campoNumeroGuia").val("");
                $("#campoCodigoRastreo").val("");
                $("#campoAcuses").val("");
                $("#campoTipoServicio").val("");
                $("#campoSobrepeso").val("");
                $("#campoTotalAcuses").val("");
                $(".archivoComprobante").text("Seleccionar Archivo");
                $(".custom-file-label").text("Seleccionar Archivo");
                $(".archivoComprobante").text("Seleccionar Archivo");
            }

            function ocultaCamposIncidencia() {
                $("#divFechaProgramada").css("display", "none");
                $("#divFechaEntrega").css("display", "none");
                $("#divNumeroGuia").css("display", "none");
                $("#divCodigoRastreo").css("display", "none");
                $("#divTieneAcuse").css("display", "none");
                $("#divTotalAcuses").css("display", "none");
                $("#divSobrepeso").css("display", "none");
                $("#divTipoServicio").css("display", "none");
                $("#divTipoIndemnizacion").css("display", "none");
                $("#divArchivoActa").css("display", "none");
                $("#divArchivoEscrito").css("display", "none");
                $("#divArchivoComprobante").css("display", "none");
                $("#divObservaciones").css("display", "none");
                $("#error_campoFechaProgramada").css("display", "none");
                $("#error_campoFechaEntrega").css("display", "none");
                $("#error_campoNumeroGuia").css("display", "none");
                $("#error_campoCodigoRastreo").css("display", "none");
                $("#error_campoAcuses").css("display", "none");
                $("#error_campoTotalAcuses").css("display", "none");
                $("#error_campoSobrepeso").css("display", "none");
                $("#error_campoTipoServicio").css("display", "none");
                $("#error_campoTipoIndemnizacion").css("display", "none");
                $("#error_archivoActa").css("display", "none");
                $("#error_archivoEscrito").css("display", "none");
                $("#error_archivoComprobante").css("display", "none");
                $("#error_observaciones").css("display", "none");
            }

            function muestraCamposIncidencia(pregunta, abreviacion) {
                for (var i = 0; i < configuracion.length; i++) {
                    let respuesta = $("input[name='" + abreviacion + "']:checked").val();
                    if (configuracion[i].pregunta == pregunta && configuracion[i].respuesta + "" == respuesta) {
                        if (configuracion[i].fechaProgramada) {
                            $("#divFechaProgramada").css("display", "block");
                            if (abreviacion == "MaterialEmbalaje") {
                                $("#divFechaProgramada > label").text("Fecha de Solicitud");
                            }
                        }

                        if (configuracion[i].fechaEntrega) {
                            $("#divFechaEntrega").css("display", "block");
                            if (abreviacion == "Recoleccion") {
                                $("#divFechaEntrega> label").text("Fecha de Recolección");
                            }
                        }

                        if (configuracion[i].numeroGuia) {
                            $("#divNumeroGuia").css("display", "block");
                        }

                        if (configuracion[i].codigoRastreo) {
                            $("#divCodigoRastreo").css("display", "block");
                        }

                        if (configuracion[i].acuse) {
                            $("#divTieneAcuse").css("display", "block");
                        }

                        if (configuracion[i].totalAcuses) {
                            $("#divTotalAcuses").css("display", "block");
                        }

                        if (configuracion[i].tipoServicio) {
                            $("#divTipoServicio").css("display", "block");
                        }

                        if (configuracion[i].tipoIndemnizacion) {
                            $("#divTipoIndemnizacion").css("display", "block");
                        }

                        if (configuracion[i].acta) {
                            $("#divArchivoActa").css("display", "block");
                        }

                        if (configuracion[i].escrito) {
                            $("#divArchivoEscrito").css("display", "block");
                        }

                        if (configuracion[i].comprobante) {
                            $("#divArchivoComprobante").css("display", "block");
                        }

                        if (configuracion[i].observaciones) {
                            $("#divObservaciones").css("display", "block");
                        }

                        return;
                    }
                }
            }

            $("#campoTipoIncidencia").change(function () {
                llenaDetallesAreaIncidencia($(this).val());
            });

            $(".actaRE").change(function (e) {
                var archivo = e.target.files[0];
                var fileName = $(this).val().split("\\").pop();
                var ext = fileName.split('.').pop();
                if (ext == "pdf" || ext == "PDF") {
                    $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
                    if ($('.actaRE').hasClass('is-invalid')) {
                        $('.actaRE').removeClass('is-invalid');
                        $('.actaRE').addClass('is-valid');
                        $('.error_archivoActa').css('display', 'none')
                    } else {
                        $('.actaRE').addClass('is-valid');
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Servicio de Mensajería Acelerada',
                        'text': 'El archivo que intentas adjuntar no es válido. Favor de solo seleccionar archivos "PDF"'
                    });
                    $(".custom-file-label").text("Seleccionar Archivo");
                    document.getElementById('fileActa').value = '';
                    if ($('.actaRE').hasClass('is-valid')) {
                        $('.actaRE').removeClass('is-valid');
                        $('.actaRE').addClass('is-invalid');
                    }
                    $('.actaRE').addClass('is-invalid');
                    $('.error_archivoActa').css('display', 'block');
                }
            });

            $("#fileEscrito").change(function (e) {
                var archivo = e.target.files[0];
                var fileName = $(this).val().split("\\").pop();
                var ext = fileName.split('.').pop();
                if (ext == "pdf" || ext == "PDF") {
                    $(this).siblings(".archivoEscrito").addClass("selected").html(fileName);
                    if ($('#fileEscrito').hasClass('is-invalid')) {
                        $('#fileEscrito').removeClass('is-invalid');
                        $('#fileEscrito').addClass('is-valid');
                        $('.error_archivoEscrito').css('display', 'none')
                    } else {
                        $('#fileEscrito').addClass('is-valid');
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Servicio de Mensajería Acelerada',
                        'text': 'El archivo que intentas adjuntar no es válido. Favor de solo seleccionar archivos "PDF"'
                    });
                    $(".archivoEscrito").text("Seleccionar Archivo");
                    document.getElementById('fileActa').value = '';
                    if ($('#fileEscrito').hasClass('is-valid')) {
                        $('#fileEscrito').removeClass('is-valid');
                        $('#fileEscrito').addClass('is-invalid');
                    }
                    $('#fileEscrito').addClass('is-invalid');
                    $('.error_archivoEscrito').css('display', 'block');
                }
            });

            $("#fileComprobante").change(function (e) {
                var archivo = e.target.files[0];
                var fileName = $(this).val().split("\\").pop();
                var ext = fileName.split('.').pop();
                if (ext == "pdf" || ext == "PDF") {
                    $(this).siblings(".archivoComprobante").addClass("selected").html(fileName);
                    if ($('#fileComprobante').hasClass('is-invalid')) {
                        $('#fileComprobante').removeClass('is-invalid');
                        $('#fileComprobante').addClass('is-valid');
                        $('.error_archivoComprobante').css('display', 'none')
                    } else {
                        $('#fileComprobante').addClass('is-valid');
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Servicio de Mensajería Acelerada',
                        'text': 'El archivo que intentas adjuntar no es válido. Favor de solo seleccionar archivos "PDF"'
                    });
                    $(".archivoComprobante").text("Seleccionar Archivo");
                    document.getElementById('fileComprobante').value = '';
                    if ($('#fileComprobante').hasClass('is-valid')) {
                        $('#fileComprobante').removeClass('is-valid');
                        $('#fileComprobante').addClass('is-invalid');
                    }
                    $('#fileComprobante').addClass('is-invalid');
                    $('.error_archivoComprobante').css('display', 'block');
                }
            });

            $(".incidenciasExcel").change(function (e) {
                var archivo = e.target.files[0];
                var fileName = $(this).val().split("\\").pop();
                var ext = fileName.split('.').pop();
                if (ext == "xlsx" || ext == "XLSX") {
                    $(this).siblings(".nameExcel").addClass("selected").html(fileName);
                    if ($('.incidenciasExcel').hasClass('is-invalid')) {
                        $('.incidenciasExcel').removeClass('is-invalid');
                        $('.incidenciasExcel').addClass('is-valid');
                        $('.error_archivoExcel').css('display', 'none')
                    } else {
                        $('.incidenciasExcel').addClass('is-valid');
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Servicio de Mensajería Acelerada',
                        'text': 'El archivo que intentas adjuntar no es válido. Favor de solo seleccionar archivos "PDF"'
                    });
                    $(".nameExcel").text("Seleccionar Archivo");
                    document.getElementById('incidenciasExcel').value = '';
                    if ($('.incidenciasExcel').hasClass('is-valid')) {
                        $('.incidenciasExcel').removeClass('is-valid');
                        $('.incidenciasExcel').addClass('is-invalid');
                    }
                    $('.incidenciasExcel').addClass('is-invalid');
                    $('.error_archivoExcel').css('display', 'block');
                }
            });

            $(document).on("click",".editIncidencia",function () {
                limpiaCampos();
                ocultaCamposIncidencia();
                editarIncidencia($(this).data("pregunta"), $(this).data("incidencia"), $(this).data("abreviacion"));
                $(".titleAddI").text("Editar Incidencia - " + $(this).data("titulo"));
                $("#campoIdIncidencia").val($(this).data("incidencia"));
                $("#campoIncidenciaId").val($(this).data("incidenciaid"));
                $("#campoPregunta").val($(this).data("pregunta"));
                $("#campoPreguntaId").val($(this).data("preguntaid"));
                $("#modal-incidencias").modal("show");
            });

            function editarIncidencia(pregunta, id, abreviacion) {
                for (var i = 0; i < respuestas[pregunta - 1].iMensajeria.length; i++) {
                    let respuesta = $("input[name='" + abreviacion + "']:checked").val();
                    if (respuestas[pregunta - 1].iMensajeria[i].id == id && respuestas[pregunta - 1].respuesta + "" == respuesta) {
                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.fechaProgramada) {
                            $("#campoFechaProgramada").val(respuestas[pregunta - 1].iMensajeria[i].fechaProgramada.slice(0, 10));
                            $("#divFechaProgramada").css("display", "block");
                        }

                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.fechaEntrega) {
                            $("#campoFechaEntrega").val(respuestas[pregunta - 1].iMensajeria[i].fechaEntrega.slice(0, 10));
                            if (abreviacion == "Recoleccion") {
                                $("#divFechaProgramada > label").text("Fecha de Recolección");
                            }
                            $("#divFechaEntrega").css("display", "block");
                        }

                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.numeroGuia) {
                            $("#campoNumeroGuia").val(respuestas[pregunta - 1].iMensajeria[i].numeroGuia);
                            $("#divNumeroGuia").css("display", "block");
                        }

                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.codigoRastreo) {
                            $("#campoCodigoRastreo").val(respuestas[pregunta - 1].iMensajeria[i].codigoRastreo);
                            $("#divCodigoRastreo").css("display", "block");
                        }

                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.acuse) {
                            $("#campoAcuses").val(respuestas[pregunta - 1].iMensajeria[i].acuse).change();
                            $("#divTieneAcuse").css("display", "block");
                        }

                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.totalAcuses) {
                            $("#campoTotalAcuses").val(respuestas[pregunta - 1].iMensajeria[i].totalAcuses);
                            $("#divTotalAcuses").css("display", "block");
                        }

                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.tipoServicio) {
                            $("#campoTipoServicio").val(respuestas[pregunta - 1].iMensajeria[i].tipoServicio);
                            $("#divTipoServicio").css("display", "block");
                            if (respuestas[pregunta - 1].iMensajeria[i].tipoServicio.includes("Sobrepeso"))
                            {
                                $("#campoSobrepeso").val(respuestas[pregunta - 1].iMensajeria[i].sobrepeso);
                                $("#divSobrepeso").css("display", "block");
                            }
                        }

                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.tipoIndemnizacion) {
                            var indemnizacion = respuestas[pregunta - 1].iMensajeria[i].indemnizacionId;
                            axios.get('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?Incidencia=' + respuestas[pregunta - 1].iMensajeria[i].incidenciaId +'&handler=IndemnizacionByIncidencia').then(response => {
                                if (response.status == 200)
                                {
                                    var options = '<option value="0">Seleccione una opción</option>';
                                    for (var i = 0; i < response.data.length; i++) {
                                        options += '<option value="' + response.data[i].id + '">' + response.data[i].nombre + '</option>'
                                    }
                                    $("#campoTipoIndemnizacion").html(options);
                                    $("#campoTipoIndemnizacion").val(indemnizacion);
                                }
                            });
                            $("#divTipoIndemnizacion").css("display", "block");
                            if (respuestas[pregunta - 1].iMensajeria[i].sobrepeso != 0)
                            {
                                $("#campoSobrepeso").val(respuestas[pregunta - 1].iMensajeria[i].sobrepeso);
                                $("#divSobrepeso").css("display", "block");
                            }
                        }

                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.acta) {
                            $(".nameActaRE").text(respuestas[pregunta - 1].iMensajeria[i].acta != "" ? respuestas[pregunta - 1].iMensajeria[i].acta : "Seleccionar Archivo");
                            $("#divArchivoActa").css("display", "block");
                        }

                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.escrito) {
                            $(".archivoEscrito").text(respuestas[pregunta - 1].iMensajeria[i].escrito);
                            $("#divArchivoEscrito").css("display", "block");
                        }

                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.comprobante) {
                            $(".archivoComprobante").text(respuestas[pregunta - 1].iMensajeria[i].comprobante);
                            $("#divArchivoComprobante").css("display", "block");
                        }


                        if (respuestas[pregunta - 1].iMensajeria[i].ciMensajeria.observaciones) {
                            $("#campoObservaciones").val(respuestas[pregunta - 1].iMensajeria[i].observaciones);
                            $("#divObservaciones").css("display", "block");
                        }

                        return;
                    }
                }
            }

            function validaCamposByPregunta(pregunta) {
                var denegate = false;
                for (var i = 0; i < configuracion.length; i++) {
                    if (configuracion[i].pregunta == pregunta && configuracion[i].obligatorio) {
                        if (configuracion[i].fechaProgramada) {
                            var pregunta = $("#campoPreguntaId").val();


                            if ($("#campoFechaProgramada").val() == "") {
                                denegate = true;
                                $("#error_campoFechaProgramada").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "No ha capturado la <b>Fecha Programada</b>."
                                }).then(function () {
                                    return false;
                                });
                            }


                                @*if ($("#campoFechaProgramada").val() != "") {
                                    console.log("Valor de CampoFechaProgramada:", campoFechaProgramada);

                                    const Incidencia = new Date($("#campoFechaProgramada").val());

                                 const mes = Incidencia.getMonth() + 1;
                                 const dia = Incidencia.getDate();

                                if (mes != @Model.Cedula.Mes.Id) {
                                        console.log("Valor de CampoFechaInci:", mes, dia);
                                        console.log("Valor del Modelo:", @Model.Cedula.Mes.Id);

                                    denegate = true;
                                    $("#error_campoFechaProgramada").css("display", "block");
                                    Swal.fire({
                                        'icon': 'error',
                                        'title': 'Servicio de Mensajería Acelerada',
                                           'backdrop': 'rgba(255,0,0,0.2)', // Fondo semitransparente rojo

                                        'html': "<b>El mes de la fecha programada no corresponde a @Model.Cedula.Mes.Nombre </b>"

                                    }).then(function () {
                                        return false;
                                    });
                                     }
                                }*@
                        }




                        if (configuracion[i].fechaEntrega) {
                            if ($("#campoFechaEntrega").val() == "") {
                                denegate = true;
                                $("#error_campoFechaEntrega").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "No ha capturado la <b>Fecha de Entrega</b>."
                                }).then(function () {
                                    return false;
                                });
                            }
                        }

                        if (configuracion[i].fechaEntrega && configuracion[i].fechaProgramada) {
                            var anioMax = @Html.Raw(Json.Serialize(DateTime.Now.Year + 1));
                            var anioMin = @Html.Raw(Json.Serialize(DateTime.Now.Year-1));

                            var anioFP = $("#campoFechaProgramada").val().split("-")[0];
                            var anioFE = $("#campoFechaEntrega").val().split("-")[0];

                            if (parseInt(anioFP) < anioMin || parseInt(anioFP) > anioMax)
                            {
                                denegate = true;
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "El año de la <b>Fecha Programada</b> no es válido."
                                }).then(function () {
                                    return false;
                                });
                            }

                            if (parseInt(anioFE) < anioMin || parseInt(anioFE) > anioMax)
                            {
                                denegate = true;
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "El año de la <b>Fecha de Entrega</b> no es válido."
                                }).then(function () {
                                    return false;
                                });
                            }

                            if ($("#campoFechaEntrega").val() <= $("#campoFechaProgramada").val()) {
                                denegate = true;
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "La <b>Fecha de Entrega</b> debe ser mayor a la <b>Fecha Programada</b>."
                                }).then(function () {
                                    return false;
                                });
                            }
                        }

                        if (configuracion[i].numeroGuia) {
                            if ($("#campoNumeroGuia").val() == "") {
                                denegate = true;
                                $("#error_campoNumeroGuia").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "El <b>Número de Guía</b> no se ha capturado."
                                }).then(function () {
                                    return false;
                                });
                            }
                            else if ($("#campoNumeroGuia").val() != "" && $("#campoNumeroGuia").val().length < 21) {
                                denegate = true;
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "Asegurese de haber capturado un <b>Número de Guía</b> válido."
                                }).then(function () {
                                    return false;
                                });
                            }
                        }

                        if (configuracion[i].codigoRastreo) {
                            if ($("#campoCodigoRastreo").val() == "") {
                                denegate = true;
                                $("#error_campoCodigoRastreo").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "El <b>Código de Rastreo</b> no se ha capturado."
                                }).then(function () {
                                    return false;
                                });
                            }
                            else if ($("#campoCodigoRastreo").val() != "" && $("#campoCodigoRastreo").val().length < 9) {
                                denegate = true;
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "Asegurese de haber capturado un <b>Código de Rastreo</b> válido."
                                }).then(function () {
                                    return false;
                                });
                            }
                        }

                        if (configuracion[i].totalAcuses) {
                            if ($("#campoTotalAcuses").val() == 0) {
                                denegate = true;
                                $("#error_campoTotalAcuses").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "No se han capturado el <b>Total de Acuses</b>."
                                }).then(function () {
                                    return false;
                                });
                            }
                        }

                        if (configuracion[i].acuse) {
                            if ($("#campoAcuses").val() == "") {
                                denegate = true;
                                $("#error_campoAcuses").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "No se ha seleccionado si <b>Tiene Acuse</b>."
                                }).then(function () {
                                    return false;
                                });
                            }
                        }

                        if (configuracion[i].tipoServicio) {
                            if ($("#campoTipoServicio").val() == "") {
                                denegate = true;
                                $("#error_campoTipoServicio").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "No se ha seleccionado el <b>Tipo de Servicio</b>."
                                }).then(function () {
                                    return false;
                                });
                            }
                            else
                            {
                                if ($("#campoTipoServicio").val() == "Nacional Sobrepeso" && ($("#campoSobrepeso").val() == "" || $("#campoSobrepeso").val() == 0)) {
                                    denegate = true;
                                    $("#error_campoSobrepeso").css("display", "block");
                                    Swal.fire({
                                        'icon': 'error',
                                        'title': 'Servicio de Mensajería Acelerada',
                                        'html': "No se ha capturado el <b>sobrepeso</b>."
                                    }).then(function () {
                                        return false;
                                    });
                                }

                                if ($("#campoTipoServicio").val() == "Internacional Sobrepeso" && ($("#campoSobrepeso").val() == "" || $("#campoSobrepeso").val() == 0)) {
                                    denegate = true;
                                    $("#error_campoSobrepeso").css("display", "block");
                                    Swal.fire({
                                        'icon': 'error',
                                        'title': 'Servicio de Mensajería Acelerada',
                                        'html': "No se ha capturado el <b>sobrepeso</b>."
                                    }).then(function () {
                                        return false;
                                    });
                                }

                                if ($("#campoSobrepeso").val() != 0 && $("#campoSobrepeso").val() != "" && $("#campoSobrepeso").val() > 100) {
                                    denegate = true;
                                    Swal.fire({
                                        'icon': 'error',
                                        'title': 'Servicio de Mensajería Acelerada',
                                        'html': "El <b>Sobrepeso</b> no puede exceder los 70Kg."
                                    }).then(function () {
                                        return false;
                                    });
                                }
                            }
                        }

                        if (configuracion[i].tipoIndemnizacion) {
                            var sel = document.getElementById("campoTipoIndemnizacion");
                            var text = sel.options[sel.selectedIndex].text;
                            if ($("#campoTipoIndemnizacion").val() == "" || $("#campoTipoIndemnizacion").val() == 0) {
                                denegate = true;
                                $("#error_campoTipoIndemnizacion").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "No se ha seleccionado el <b>Tipo de Indemnización</b>."
                                }).then(function () {
                                    return false;
                                });
                            }
                            else
                            {
                                if (text == "Expediente" && ($("#campoSobrepeso").val() == "" || $("#campoSobrepeso").val() == 0)) {
                                    denegate = true;
                                    $("#error_campoSobrepeso").css("display", "block");
                                    Swal.fire({
                                        'icon': 'error',
                                        'title': 'Servicio de Mensajería Acelerada',
                                        'html': "No se ha capturado el <b>sobrepeso</b>."
                                    }).then(function () {
                                        return false;
                                    });
                                }

                                if (text == "Bienes" && ($("#campoSobrepeso").val() == "" || $("#campoSobrepeso").val() == 0)) {
                                    denegate = true;
                                    $("#error_campoSobrepeso").css("display", "block");
                                    Swal.fire({
                                        'icon': 'error',
                                        'title': 'Servicio de Mensajería Acelerada',
                                        'html': "No se ha capturado el <b>sobrepeso</b>."
                                    }).then(function () {
                                        return false;
                                    });
                                }

                                if ($("#campoSobrepeso").val() != 0 && $("#campoSobrepeso").val() != "" && $("#campoSobrepeso").val() > 100) {
                                    denegate = true;
                                    Swal.fire({
                                        'icon': 'error',
                                        'title': 'Servicio de Mensajería Acelerada',
                                        'html': "El <b>Sobrepeso</b> no puede exceder los 200Kg."
                                    }).then(function () {
                                        return false;
                                    });
                                }
                            }
                        }

                        if (configuracion[i].acta) {
                            var acta = document.getElementById('fileActa').files[0];
                            if (acta == null && $(".nameActaRE").text() == "Seleccionar Archivo") {
                                denegate = true;
                                $("#error_archivoActa").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "Asegurese de haber cargado una <b>Acta del MP</b> válido."
                                }).then(function () {
                                    return false;
                                });
                            }
                        }

                        if (configuracion[i].escrito) {
                            var escrito = document.getElementById('fileEscrito').files[0];
                            if (escrito == null && $(".archivoEscrito").text() == "Seleccionar Archivo") {
                                denegate = true;
                                $("#error_archivoEscrito").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "Asegurese de haber cargado un <b>Escrito de robo/extravío</b> válido."
                                }).then(function () {
                                    return false;
                                });
                            }
                        }

                        if (configuracion[i].comprobante) {
                            var escrito = document.getElementById('fileComprobante').files[0];
                            if (escrito == null && $(".archivoComprobante").text() == "Seleccionar Archivo") {
                                denegate = true;
                                $("#error_archivoComprobante").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "Asegurese de haber cargado un <b>Comprobante</b> válido."
                                }).then(function () {
                                    return false;
                                });
                            }
                        }

                        if (configuracion[i].observaciones) {
                            if ($("#campoObservaciones").val() == "") {
                                denegate = true;
                                $("#error_observaciones").css("display", "block");
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': "No se han capturado las <b>Observaciones</b>."
                                }).then(function () {
                                    return false;
                                });
                            }
                        }
                    }
                }

                if (denegate == false) {
                    return true;
                }
            }

            $("#guardaIncidencia").click(function () {
                var formData = new FormData();

                var idIncidencia = $("#campoIdIncidencia").val() != "" ? $("#campoIdIncidencia").val():0;
                var incidenciaId = $("#campoIncidenciaId").val();
                var pregunta = $("#campoPregunta").val();
                var preguntaId = $("#campoPreguntaId").val();
                var fechaProgramada = $("#campoFechaProgramada").val() != null && $("#campoFechaProgramada").val() != "" ? $("#campoFechaProgramada").val() : "1990-01-01";
                var fechaEntrega = $("#campoFechaEntrega").val() != null && $("#campoFechaEntrega").val() != "" ? $("#campoFechaEntrega").val() : "1990-01-01";
                var numeroGuia = $("#campoNumeroGuia").val() != null && $("#campoNumeroGuia").val() != "" ? $("#campoNumeroGuia").val() : "";
                var codigoRastreo = $("#campoCodigoRastreo").val() != null && $("#campoCodigoRastreo").val() != "" ? $("#campoCodigoRastreo").val() : "";
                var acuse = $("#campoAcuses").val() != null && $("#campoAcuses").val() != "" ? $("#campoAcuses").val() : "";
                var tipoServicio = $("#campoTipoServicio").val() != null && $("#campoTipoServicio").val() != "" ? $("#campoTipoServicio").val() : "";
                var tipoIndemnizacion = $("#campoTipoIndemnizacion").val() != null && $("#campoTipoIndemnizacion").val() != 0 ? $("#campoTipoIndemnizacion").val() : 0;
                var sobrepeso = $("#campoSobrepeso").val() != null && $("#campoSobrepeso").val() != "" ? $("#campoSobrepeso").val() : "";
                var totalAcuses = $("#campoTotalAcuses").val() != null && $("#campoTotalAcuses").val() != "" ? $("#campoTotalAcuses").val() : 0;
                var observaciones = $("#campoObservaciones").val() != null && $("#campoObservaciones").val() != "" ? $("#campoObservaciones").val() : 0;

                var acta = document.getElementById('fileActa').files[0];
                var escrito = document.getElementById('fileEscrito').files[0];
                var comprobante = document.getElementById('fileComprobante').files[0];

                formData.append("IncidenciaId", parseInt(incidenciaId));
                formData.append("IndemnizacionId", tipoIndemnizacion);
                formData.append("CedulaEvaluacionId", cedula.id);
                formData.append("UsuarioId", usuario);
                formData.append("Pregunta", pregunta);
                formData.append("FechaProgramada", fechaProgramada);
                formData.append("FechaEntrega", fechaEntrega);
                formData.append("NumeroGuia", numeroGuia);
                formData.append("CodigoRastreo", codigoRastreo);
                formData.append("Acuse", acuse);
                formData.append("TotalAcuses", parseInt(totalAcuses));
                formData.append("TipoServicio", tipoServicio);
                formData.append("Sobrepeso", parseFloat(sobrepeso));
                formData.append("Observaciones", observaciones);

                if (acta != null) {
                    formData.append("Acta", acta);
                }

                if (escrito != null) {
                    formData.append("Escrito", escrito);
                }

                if (comprobante!= null) {
                    formData.append("Comprobante", comprobante);
                }

                Swal.fire({
                    allowOutsideClick: false,
                    icon: "info",
                    title: "Servicio de Mensajería Acelerada",
                    html: "Guardando la incidencia, espere por favor."
                });
                Swal.showLoading();
                if (validaCamposByPregunta(preguntaId)) {
                    if (idIncidencia != 0) {
                        formData.append("Id", parseInt(idIncidencia));

                        axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=ActualizarIncidencia', formData, { headers: { 'Content-Type': 'multipart/form-data' } }).then(response => {
                            if (response.status == 200) {
                                Swal.fire({
                                    icon: "success",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "La incidencia se actualizó correctamente.",
                                    confirmButtonText: 'Cerrar'
                                }).then(function () {
                                    $("#modal-incidencias").modal("hide");
                                    Swal.fire({
                                        allowOutsideClick: false,
                                        icon: "info",
                                        title: "Servicio de Mensajería Acelerada",
                                        html: "Actualizando las incidencias, espere por favor."
                                    });
                                    Swal.showLoading();
                                    window.location.reload();
                                });
                            }
                        }).catch(error => {
                            Swal.fire({
                                icon: "error",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "Hubo un error al insertar la incidencia. Contacte a su administrador del sistema.",
                                confirmButtonText: 'Cerrar'
                            });
                        });
                    }
                    else {
                        axios.post('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=CrearIncidencia', formData, { headers: { 'Content-Type': 'multipart/form-data' } }).then(response => {
                            if (response.status == 200) {
                                Swal.fire({
                                    icon: "success",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "La incidencia se registró correctamente.",
                                    confirmButtonText: 'Cerrar'
                                }).then(function () {
                                    $("#modal-incidencias").modal("hide");
                                    Swal.fire({
                                        allowOutsideClick: false,
                                        icon: "info",
                                        title: "Servicio de Mensajería Acelerada",
                                        html: "Actualizando las incidencias, espere por favor."
                                    });
                                    Swal.showLoading();
                                    window.location.reload();
                                });
                            }
                        }).catch(error => {
                            Swal.fire({
                                icon: "error",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "Hubo un error al insertar la incidencia. Contacte a su administrador del sistema.",
                                confirmButtonText: 'Cerrar'
                            });
                        });
                    }
                }
            });

            $("#guardaExcel").click(function () {
                var formData = new FormData();

                var incidenciaId = $("#campoIncidenciaId").val();
                var pregunta = $("#campoPregunta").val();

                var excel = document.getElementById('fileExcel').files[0];

                formData.append("IncidenciaId", parseInt(incidenciaId));
                formData.append("CedulaEvaluacionId", cedula.id);
                formData.append("Folio", cedula.folio);
                formData.append("UsuarioId", usuario);
                formData.append("Pregunta", pregunta);

                Swal.fire({
                    allowOutsideClick: false,
                    icon: "info",
                    title: "Servicio de Mensajería Acelerada",
                    html: "Importando incidencias, espere por favor."
                });
                Swal.showLoading();
                if (excel != null) {
                    formData.append("Excel", excel);
                    axios.post('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=CrearIncidenciaExcel', formData, { headers: { 'Content-Type': 'multipart/form-data' } }).then(excel => {
                        if (excel.status == 200)
                        {
                            if (excel.data.status == 200)
                            {
                                Swal.fire({
                                    icon: "success",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Se importaron todas las incidencias del archivo de excel correctamente.",
                                    confirmButtonText: 'Cerrar'
                                }).then(function () {
                                    $("#modal-incidencias").modal("hide");
                                    Swal.fire({
                                        allowOutsideClick: false,
                                        icon: "info",
                                        title: "Servicio de Mensajería Acelerada",
                                        html: "Actualizando las incidencias, espere por favor."
                                    });
                                    Swal.showLoading();
                                    window.location.reload();
                                });
                            }
                            else if (excel.data.status == 205)
                            {
                                Swal.fire({
                                    icon: "warning",
                                    title: 'Servicio de Mensajería Acelerada',
                                    allowOutsideClick: false,
                                    html: "Se encontraron errores en la carga del archivo de excel, favor de descargar el reporte y revisar las observaciones pertinentes.",
                                    confirmButtonText: 'Generar Reporte'
                                }).then(function () {
                                    Swal.fire({
                                        allowOutsideClick: false,
                                        icon: "info",
                                        title: "Servicio de Mensajería Acelerada",
                                        html: "Generando Reporte, espere por favor."
                                    });
                                    Swal.showLoading();
                                    $.ajax({
                                        url: '/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Html.Raw(Json.Serialize(Model.Cedula.InmuebleId))+'/' + @Html.Raw(Json.Serialize(Model.Cedula.Id))+'?handler=ReporteErrorIE',
                                        type: "post",
                                        contentType: 'application/json; charset=utf-8',
                                        xhrFields: { responseType: 'blob' },
                                        data: JSON.stringify(excel.data.incidencias),
                                        success: function (response) {
                                            var blob = new Blob([response], { type: 'data:application/vnd.ms-excel' });
                                            const href = URL.createObjectURL(blob);

                                            const link = document.createElement('a');
                                            link.href = href;
                                            link.setAttribute('download', 'Reporte de Carga Masiva.xlsx'); //or any other extension
                                            document.body.appendChild(link);
                                            link.click();

                                            document.body.removeChild(link);
                                            URL.revokeObjectURL(href);
                                            Swal.fire({
                                                allowOutsideClick: false,
                                                icon: "info",
                                                title: 'Servicio de Mensajería Acelerada',
                                                html: "El <b>Reporte se generó correctamente</b>.",
                                                confirmButtonText: 'Descargar'

                                            });
                                            Swal.hideLoading();
                                            $("#modal-incidencias").modal("hide");
                                        }
                                    });
                                });
                            }
                        }
                    }).catch(error => {
                        Swal.fire({
                            icon: "error",
                            title: 'Servicio de Mensajería Acelerada',
                            html: "Hubo un error al insertar la incidencia. Contacte a su administrador del sistema.",
                            confirmButtonText: 'Cerrar'
                        });
                    });
                }
                else
                {
                    $("#error_archivoExcel").css("display", "block");
                    Swal.fire({
                        allowOutsideClick: false,
                        icon: "info",
                        title: "Servicio de Mensajería Acelerada",
                        html: "Aún faltan campos por capturar."
                    });
                }
            });

            $(".eliminarIncidencia").click(function () {
                var formData = new FormData();

                var idIncidencia = $(this).data('id');

                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Está seguro que desea <b>Eliminar</b> la incidencia de la cédula de evaluación?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, Eliminar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    axios.post('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=EliminarIncidencia', {
                        Id: parseInt(idIncidencia), CedulaEvaluacionId: parseInt(cedula.id), UsuarioId: usuario
                    }).then(response => {
                        if (response.status == 200) {
                            Swal.fire({
                                icon: "success",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "La incidencia se eliminó correctamente.",
                                confirmButtonText: 'Cerrar'
                            }).then(function () {
                                $("#modal-incidencias").modal("hide");
                                Swal.fire({
                                    allowOutsideClick: false,
                                    icon: "info",
                                    title: "Servicio de Mensajería Acelerada",
                                    html: "Actualizando las incidencias, espere por favor."
                                });
                                Swal.showLoading();
                                window.location.reload();
                            });
                        }
                    }).catch(error => {
                        Swal.fire({
                            icon: "error",
                            title: 'Servicio de Mensajería Acelerada',
                            html: "Hubo un error al eliminar la incidencia. Contacte a su administrador del sistema.",
                            confirmButtonText: 'Cerrar'
                        });
                    });
                });
            });

            $('#campoTotalAcuses').keydown(function (e) {
                setTimeout(() => {
                    let montoMax = $('#campoTotalAcuses').val().split(".");
                    let valorMx = montoMax[0].replace(/\D/g, ""), decimalMx = montoMax[1]

                    let gNumero = Number((decimalMx !== undefined ? valorMx + "." + decimalMx : valorMx));
                    let numeroFmx = new Intl.NumberFormat('en-EN').format(valorMx);
                    numeroFmx = decimalMx !== undefined ? numeroFmx + "." + decimalMx : numeroFmx;
                    $('#campoTotalAcuses').val(numeroFmx);
                })
            });

            $("#campoTotalAcuses").on("input", function () {
                var limite = 6;
                $("#campoTotalAcuses").attr('maxlength', limite);
            });

            $('#campoSobrepeso').on('keyup', function () {
                v = parseInt($(this).val());
                min = parseInt($(this).attr('min'));
                max = parseInt($(this).attr('max'));
                if (v > max) {
                    $(this).val(max);
                }
            });

            $("#campoSobrepeso").change(function () {
                var sel = document.getElementById("campoTipoIndemnizacion");
                var text = sel.options[sel.selectedIndex].text;
                if ($("#campoTipoServicio").val() == "Nacional Sobrepeso" || $("#campoTipoServicio").val() == "Internacional Sobrepeso"
                    || text == "Bienes" || text == "Expediente") {
                    $("#divSobrepeso").css("display", "block");
                } else {
                    $("#divSobrepeso").css("display", "none");
                    $("#total_sobrepeso").val("");
                }
            });

            $("#campoTipoServicio").change(function () {
                if ($(this).val() == "Nacional Sobrepeso" || $(this).val() == "Internacional Sobrepeso") {
                    $("#divSobrepeso").css("display", "block");
                } else {
                    $("#divSobrepeso").css("display", "none");
                    $("#campoTipoIndemnizacion").val(0);
                    $("#campoSobrepeso").val("");
                    $("#total_sobrepeso").val("");
                }
            });

            $("#campoTipoIndemnizacion").change(function () {
                var sel = document.getElementById("campoTipoIndemnizacion");
                var text = sel.options[sel.selectedIndex].text;
                if (text == "Expediente" || text == "Bienes") {
                    if ($("#campoTipoServicio").val() == "Internacional")
                    {
                        $("#campoTipoServicio").val("Internacional Sobrepeso");
                    }
                    else if ($("#campoTipoServicio").val() == "Nacional")
                    {
                        $("#campoTipoServicio").val("Nacional Sobrepeso");
                    }
                    $("#divSobrepeso").css("display", "block");
                } else {
                    if ($("#campoTipoServicio").val() == "Internacional Sobrepeso") {
                        $("#campoTipoServicio").val("Internacional");
                    }
                    else if ($("#campoTipoServicio").val() == "Nacional Sobrepeso") {
                        $("#campoTipoServicio").val("Nacional");
                    }
                    $("#divSobrepeso").css("display", "none");
                    $("#campoSobrepeso").val("");
                    $("#total_sobrepeso").val("");
                }
            });

            $(".pregunta").change(function () {
                var pregunta = $(this).data("pregunta");
                var pusuario = $(this).data("pusuario");
                var abreviacion = $(this).data("abreviacion");
                var respuesta = $("input[name='" + abreviacion + "']:checked").val();
                var obligatorio = $(this).data('obligatorio');

                if (obligatorio == "True" && cuentaIncidencias(cedula.id, pusuario) != 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Servicio de Mensajería Acelerada',
                        html: '<strong>Advertencia:</strong><p>Tiene incidencias capturadas en esta pregunta, al cambiar la respuesta <strong>se eliminarán todas las incidencias. ¿Desea continuar? </strong></p>',
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Si, eliminar',
                        cancelButtonText: 'Cancelar',
                        showCancelButton: true
                    }).then(p => {
                        if (p.isConfirmed) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Servicio de Mensajería Acelerada',
                                html: 'Escriba la palabra ELIMINAR en para confirmar el cambio de respuesta.',
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Si, eliminar todo',
                                cancelButtonText: 'Cancelar',
                                showCancelButton: true,
                                input: 'text',
                                inputPlaceholder: 'Escribe la palabra ELIMINAR'
                            }).then(res => {
                                if (res.value == 'ELIMINAR' || res.value == 'eliminar') {
                                    axios.post('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=EliminarIncidencias', {
                                        CedulaEvaluacionId: parseInt(cedula.id), Pregunta: parseInt(pusuario)
                                    }).then(response => {
                                        Swal.fire({
                                            allowOutsideClick: false,
                                            icon: "info",
                                            title: "Servicio de Mensajería Acelerada",
                                            html: "Eliminando las incidencias, espere por favor."
                                        });
                                        Swal.showLoading();
                                        Swal.fire({
                                            icon: "success",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: 'Se eliminaron las incidencias de la pregunta ' + pusuario + '.',
                                            confirmButtonText: 'Cerrar'
                                        }).then(function () {
                                            guardarCedula();
                                        });
                                    });
                                }
                                else if (dismiss = 'cancel') {
                                    $('input:radio[name="' + abreviacion + '"][value="' + (!respuesta + "") + '"]').prop('checked', true);
                                }
                            });
                        }
                        else {
                            $('input:radio[name="' + abreviacion + '"][value="' + (!respuesta + "") + '"]').prop('checked', true);
                        }
                    });
                }
                else
                {
                    for (var i = 0; i < configuracion.length; i++)
                    {
                        if (configuracion[i].pregunta == pregunta && (respuesta == "true") == configuracion[i].respuesta)
                        {
                            if (respuesta != "N/A") {
                                guardarCedulaCP(configuracion[i].obligatorio, pusuario, respuesta)
                            }
                            else if (respuesta == "N/A") {
                                guardarCedulaCP(configuracion[i].obligatorio, pusuario, respuesta)
                            }

                        }
                    }
                }
            });

            $("#campoFechaProgramada").change(function () {
                if ($('#campoFechaProgramada').hasClass('is-invalid')) {
                    $('#campoFechaProgramada').removeClass('is-invalid');
                    $('#campoFechaProgramada').addClass('is-valid');
                    $('#error_campoFechaProgramada').css('display', 'none');
                }
            });

            $("#campoFechaEntrega").change(function () {
                if ($('#campoFechaEntrega').hasClass('is-invalid')) {
                    $('#campoFechaEntrega').removeClass('is-invalid');
                    $('#campoFechaEntrega').addClass('is-valid');
                    $('#error_campoFechaEntrega').css('display', 'none');
                }
            });

            $("#campoCodigoRastreo").change(function () {
                if ($('#campoCodigoRastreo').hasClass('is-invalid')) {
                    $('#campoCodigoRastreo').removeClass('is-invalid');
                    $('#campoCodigoRastreo').addClass('is-valid');
                    $('#error_campoCodigoRastreo').css('display', 'none');
                }
            });

            $("#campoNumeroGuia").change(function () {
                if ($('#campoNumeroGuia').hasClass('is-invalid')) {
                    $('#campoNumeroGuia').removeClass('is-invalid');
                    $('#campoNumeroGuia').addClass('is-valid');
                    $('#error_campoNumeroGuia').css('display', 'none');
                }
            });

            $("#campoAcuses").change(function () {
                if ($('#campoAcuses').hasClass('is-invalid')) {
                    $('#campoAcuses').removeClass('is-invalid');
                    $('#campoAcuses').addClass('is-valid');
                    $('#error_campoAcuses').css('display', 'none');
                }
            });

            $("#campoTipoServicio").change(function () {
                if ($('#campoTipoServicio').hasClass('is-invalid')) {
                    $('#campoTipoServicio').removeClass('is-invalid');
                    $('#campoTipoServicio').addClass('is-valid');
                    $('#error_campoTipoServicio').css('display', 'none');
                }
            });

            $("#campoTotalAcuses").change(function () {
                if ($('#campoTotalAcuses').hasClass('is-invalid')) {
                    $('#campoTotalAcuses').removeClass('is-invalid');
                    $('#campoTotalAcuses').addClass('is-valid');
                    $('#error_campoTotalAcuses').css('display', 'none');
                }
            });

            $("#campoSobrepeso").change(function () {
                if ($('#campoSobrepeso').hasClass('is-invalid')) {
                    $('#campoSobrepeso').removeClass('is-invalid');
                    $('#campoSobrepeso').addClass('is-valid');
                    $('#error_campoSobrepeso').css('display', 'none');
                }
            });

            $(".descargarPlantilla").click(function () {
                Swal.fire({
                    allowOutsideClick: false,
                    icon: "info",
                    title: 'Servicio de Mensajería Acelerada',
                    html: "Descargando la plantilla para la captura masiva de incidencias, espere por favor."
                });

                axios.get('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?nFacturacion=' +@Model.Repositorio.Id+'&CedulaId=' +@Model.Cedula.Id+'&nInmueble=' +@Model.Inmueble.Id+'&Handler=PlantillaIncidencias',
                    { responseType: 'blob'}).then(response => {
                    if (response.status == 200) {
                            const href = URL.createObjectURL(response.data);


                            const link = document.createElement('a');
                            link.href = href;
                            link.setAttribute('download', 'Plantilla de Incidencias.xlsx'); //or any other extension
                            document.body.appendChild(link);
                            link.click();


                            document.body.removeChild(link);
                            URL.revokeObjectURL(href);
                            Swal.fire({
                                allowOutsideClick: false,
                                icon: "info",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "La <b>Plantilla de Incidencias</b> se descargó correctamente.",
                                confirmButtonText: 'Cerrar'

                            });
                            Swal.hideLoading();
                    }
                });

            });

            /*********************************** Apartado de Incidencias **********************************/

            /*********************************** Apartado de Entregables **********************************/
            $(".editarEntregable").click(function () {
                $(".tituloEntregable").html('<h4 class="modal-title text-white">Cargar entregable - ' + $(this).data("tipo") + '</h4>');
                if ($(this).data("tipo") == "Factura" || $(this).data("tipo").includes("SAT"))
                {
                    $("#notaEntregable").html('<b>Nota:</b> Recuerde que la <b>Factura, Nota de Crédito, Validación del SAT y Validación del SAT (NC)</b> <b class="text-danger">deben ir firmadas y selladas</b> por la administración del inmueble.');
                }
                $("#campoIdEntregable").val($(this).data("id"));
                $("#campoTipoEntregable").val($(this).data("tipo"));
                $("#campoentregableid").val($(this).data("entregableid"));
                $(".custom-pdf").text($(this).data("file"));
                $("#modalEntregables").modal('show');
            });

            $("#entregablePDF").on("change", function () {
                var fileName = $(this).val().split("\\").pop();
                var ext = fileName.split('.').pop();
                if (ext == "pdf" || ext == "PDF") {
                    $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Formato Incorrecto',
                        'text': 'El archivo que intentas adjuntar no es válido. Favor de solo seleccionar archivos "PDF"'
                    });
                    $(".custom-file-label").text("Seleccionar Archivo");
                    document.getElementById('customFile').value = '';
                    if ($('#entregablePDF').hasClass('is-valid')) {
                        $('#entregablePDF').removeClass('is-valid');
                    }
                    $('#entregablePDF').addClass('is-invalid');
                    $('#error_entregablePDF').css('display', 'block');
                }
            });

            $("#guardarEntregable").click(function () {
                var formData = new FormData();
                var filePDF = document.getElementById('entregablePDF').files[0];
                var observaciones = "Se actualizó el entregable: " + $("#campoTipoEntregable").val() + ".";

                formData.append("Id", $("#campoIdEntregable").val());
                formData.append("UsuarioId", usuario);
                formData.append("EstatusId", cedula.estatusId);
                formData.append("Archivo", filePDF);
                formData.append("Anio", parseInt(cedula.anio));
                formData.append("Mes", cedula.mes.nombre);
                formData.append("Folio", cedula.folio);
                formData.append("Archivo", filePDF);
                formData.append("Supervicion", supervision);
                formData.append("Observaciones", observaciones);
                formData.append("TipoEntregable", $("#campoTipoEntregable").val());

                Swal.fire({
                    allowOutsideClick: false,
                    icon: "info",
                    title: "Servicio de Mensajería Acelerada",
                    html: "Guardando entregable, espere por favor."
                });
                Swal.showLoading();
                axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=ActualizarEntregables', formData, { headers: { 'Content-Type': 'multipart/form-data' } }).then(response => {
                    if (response.status == 200) {
                        Swal.fire({
                            icon: "success",
                            title: 'Servicio de Mensajería Acelerada',
                            html: 'El entregable <b>' + $("#campoTipoEntregable").val() + '</b> se actualizó correctamente.',
                            confirmButtonText: 'Cerrar'
                        }).then(function () {
                            Swal.fire({
                                allowOutsideClick: false,
                                icon: "info",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "Actualizando el listado de entregables, espere por favor."
                            });
                            Swal.showLoading();
                            window.location.reload();
                        });
                    }
                });
            });

            $(".verEntregable").click(function () {
                var folio = cedula.folio;
                var abreviacion = $(this).data("tipo");
                var archivo = $(this).data("archivo");
                var tipoEntregable = $(this).data("tipo");
                var observaciones = $(this).data("observaciones");

                let url = '/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?cAnio=' + @Model.Cedula.Anio+'&cMes=' + cedula.mes.nombre + '&cFolio=' + folio + '&cArchivo=' + archivo + '&tipo=' + tipoEntregable + '&handler=VisualizarEntregable';
                let data = '<object class="vistaPdf" embedded=True data="' + url + '"></object>';
                let detail = '<tr>'+
                                '<td><label>Año: </label> '+cedula.anio+'</td>'+
                                '<td><label>Mes: </label> '+cedula.mes.nombre+'</td>'+
                                '<td><label>Inmueble: </label> '+cedula.inmueble.nombre+'</td>'+
                                '<td><label>Folio: </label> '+cedula.folio+'</td>'+
                                '<td><label>Estatus: </label> ' + cedula.estatus.nombre + '</td>' +
                            '</tr>';
                let detail2 = '<tr>'+
                                '<td colspan="5"><label>Administrador: </label> ' + inmueble.administrador+ '</td>'
                            '</tr>';
                $("#titleVerEntregables").text("Vista del entregable - " + abreviacion);
                $('#detalleEntregable').html('<table class="table">' + detail+ detail2 +'</table>');
                $('#objectPdf').html(data);
                $("#modalVerEntregables").modal("show");
            });

            $(".verFactura").click(function () {
                var folio = $(this).data("folio");
                var archivo = $(this).data("archivo");
                var tipo = $(this).data("tipo");
                var subtotal = $(this).data("subtotal");
                var total = $(this).data("total");
                var iva = $(this).data("iva");

                let url = '/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?cAnio=' + @Model.Cedula.Anio+'&cMes=' + cedula.mes.nombre + '&cFolio=' + folio + '&cInmueble=' + inmueble.nombre + '&cArchivo=' + archivo + '&tipo=' + tipo+ '&handler=VisualizarFactura';
                let data = '<object class="vistaPdf" embedded=True data="' + url + '"></object>';
                let detail = '<tr>'+
                                '<td><label>Año: </label> '+ cedula.anio+'</td>'+
                                '<td><label>Mes: </label> '+ cedula.mes.nombre+'</td>'+
                                '<td><label>Inmueble: </label> '+ inmueble.nombre+'</td>'+
                                '<td><label>Folio: </label> '+folio+'</td>'+
                                '<td><label>Tipo: </label> ' + tipo+ '</td>' +
                    '</tr>';

                let detail2 = '<tr>' +
                                '<td><label>Subtotal: </label> '+ subtotal +'</td>'+
                                '<td><label>IVA: </label> '+ iva +'</td>'+
                                '<td><label>Total: </label> '+ total +'</td>'+
                                '<td></td>'+
                                '<td></td>'+
                            '</tr>';
                $("#titleVerEntregables").text("Vista del entregable - " + tipo);
                $('#detalleEntregable').html('<table class="table">' + detail+ detail2 +'</table>');
                $('#objectPdf').html(data);
                $("#modalVerEntregables").modal("show");
            });

            $(".verActa").click(function () {
                var folio = cedula.folio;
                var archivo = $(this).data("archivo");
                var tipo = $(this).data("tipo");
                var tipoArchivo = $(this).data("tipoarchivo");
                var guia = $(this).data("guia");
                var codigoRastreo = $(this).data("codigo");
                var tipoServicio = $(this).data("tiposervicio");
                var sobrepeso = $(this).data("sobrepeso");

                let url = '/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?cAnio=' + @Model.Cedula.Anio+'&cMes=' + cedula.mes.nombre + '&cFolio=' + folio + '&tipoArchivo=' + tipoArchivo + '&cArchivo=' + archivo + '&tipo=' + tipo+ '&handler=VisualizarActas';
                let data = '<object class="vistaPdf" embedded=True data="' + url + '"></object>';
                let detail = '<tr>'+
                                '<td><label>Año: </label> '+ cedula.anio+'</td>'+
                                '<td><label>Mes: </label> '+ cedula.mes.nombre+'</td>'+
                                '<td><label>Folio: </label> '+folio+'</td>'+
                                '<td><label>Tipo de Incidencia: </label> ' + tipo+ '</td>' +
                                '<td><label>Tipo de Archivo: </label> ' + tipoArchivo+ '</td>' +
                    '</tr>';

                let detail2 = '<tr>' +
                                '<td><label>Número de Guía: </label> '+ guia+'</td>'+
                                '<td><label>Código de Rastreo: </label> '+ codigoRastreo +'</td>'+
                                '<td><label>Tipo de Servicio: </label> '+tipoServicio+'</td>'+
                                '<td><label>Sobrepeso: </label> ' + sobrepeso+ '</td>' +
                                '<td></td>' +
                    '</tr>';
                $("#titleVerEntregables").text("Vista del entregable - "+tipoArchivo);
                $('#detalleEntregable').html('<table class="table">' + detail+ detail2 +'</table>');
                $('#objectPdf').html(data);
                $("#modalVerEntregables").modal("show");
            });

            $(".autorizarEntregable").click(function () {
                var formData = new FormData();

                formData.append("Id", $(this).data('id'));
                formData.append("CedulaEvaluacionId", cedula.id);
                formData.append("Estatus", "Autorizado");
                formData.append("EntregableId", $(this).data('entregableid'));
                formData.append("UsuarioId", usuario);

                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Está seguro que desea <b>Autorizar</b> el entregable <b>' + $(this).data('tipo') + '</b>?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, Autorizar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        formData.append("Observaciones", "Se autoriza el entregable.");
                        axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=AutorizarEntregables', formData, { headers: { 'Content-Type': 'multipart/form-data' } }).then(response => {
                            if (response.status == 200) {
                                Swal.fire({
                                    icon: "success",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "El entregable <b>" + $(this).data('tipo') + "</b> se autorizó correctamente.",
                                    confirmButtonText: 'Cerrar'
                                }).then(function () {
                                    Swal.fire({
                                        allowOutsideClick: false,
                                        icon: "info",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "Actualizando la cédula de evaluación, espere por favor."
                                    });
                                    Swal.showLoading();
                                    window.location.reload();
                                });
                            }
                        }).catch(error => {
                            Swal.fire({
                                icon: "error",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "Hubo un error al autorizar la cédula de evaluación. Contacte a su administrador del sistema.",
                                confirmButtonText: 'Cerrar'
                            });
                        });
                    }
                });
            });

            $(".rechazarEntregable").click(function () {
                var formData = new FormData();

                formData.append("Id", $(this).data('id'));
                formData.append("CedulaEvaluacionId", cedula.id);
                formData.append("Estatus", "Rechazado");
                formData.append("EntregableId", $(this).data('entregableid'));
                formData.append("UsuarioId", usuario);

                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Está seguro que desea <b>Rechazar</b> el ' + $(this).data('tipo') + '?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, Rechazar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Servicio de Mensajería Acelerada',
                            html: 'Por favor captura el motivo por el cual se rechaza el(la) <b>' + $(this).data('tipo') + '</b>.',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            cancelButtonText: 'Cancelar',
                            confirmButtonText: 'Rechazar',
                            input: 'textarea',
                            inputPlaceholder: 'Escriba los comentarios correspondientes'
                        }).then(coments => {
                            if (coments.value.length > 0) {
                                formData.append("Observaciones", coments.value);
                                axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=AutorizarEntregables', formData, { headers: { 'Content-Type': 'multipart/form-data' } }).then(response => {
                                    if (response.status == 200) {
                                        Swal.fire({
                                            icon: "success",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "El entregable <b>" + $(this).data('tipo') + "</b> se rechazó correctamente.",
                                            confirmButtonText: 'Cerrar'
                                        }).then(function () {
                                            Swal.fire({
                                                allowOutsideClick: false,
                                                icon: "info",
                                                title: 'Servicio de Mensajería Acelerada',
                                                html: "Actualizando la cédula de evaluación, espere por favor."
                                            });
                                            Swal.showLoading();
                                            window.location.reload();
                                        });
                                    }
                                }).catch(error => {
                                    Swal.fire({
                                        icon: "error",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "Hubo un error al autorizar la cédula de evaluación. Contacte a su administrador del sistema.",
                                        confirmButtonText: 'Cerrar'
                                    });
                                });
                            }
                        });
                    }
                });
            });

            $(".validarEntregable").click(function () {
                var formData = new FormData();

                formData.append("Id", $(this).data('id'));
                formData.append("EstatusId", $(this).data('estatusid'));
                formData.append("Observaciones", "Se valida el entregable por la DAS.");
                formData.append("Validar", true);
                formData.append("Validado", true);

                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Estas seguro de que deseas <b>Validar</b> el ' + $(this).data('tipo') + '?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, validar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=validarEntregables', formData, { headers: { 'Content-Type': 'multipart/form-data' } }).then(response => {
                            if (response.status == 200) {
                                Swal.fire({
                                    icon: "success",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "El(la) " + $(this).data('tipo') + " se validó correctamente.",
                                    confirmButtonText: 'Cerrar'
                                }).then(function () {
                                    Swal.fire({
                                        allowOutsideClick: false,
                                        icon: "info",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "Actualizando la cédula de evaluación, espere por favor."
                                    });
                                    Swal.showLoading();
                                    window.location.reload();
                                });
                            }
                        }).catch(error => {
                            Swal.fire({
                                icon: "error",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "Hubo un error al validar el entregable. Contacte a su administrador del sistema.",
                                confirmButtonText: 'Cerrar'
                            });
                        });
                    }
                });
            });

            function formatMoney(number) {
                return number.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            }
            /*********************************** Apartado de Entregables **********************************/

            /*********************************** Guardado de la Cédula **********************************/
            $(".btnRegresar").click(function () {
                Swal.fire({
                    allowOutsideClick: false,
                    icon: "info",
                    title: 'Servicio de Mensajería Acelerada',
                    html: "Regresando al listado de cédulas, espere por favor."
                });
                Swal.showLoading();
            });

            $(".guardarCedula").click(function () {
                var cRespuestas = new Array();

                for (var i = 0; i < respuestas.length; i++) {
                    let respuesta = $("input[name='" + respuestas[i].cuestionario.abreviacion + "']:checked").val();
                    if (respuesta != null && respuesta != undefined && respuesta != "N/A") {
                        cRespuestas.push({ CedulaEvaluacionId: parseInt(cedula.id), Pregunta: (i + 1),
                            Respuesta: (respuesta == "true"), UsuarioId: usuario });
                    } else if (respuesta == "N/A") {
                        cRespuestas.push({
                            CedulaEvaluacionId: parseInt(cedula.id), Pregunta: (i + 1),
                            Respuesta: (respuesta == "true"), Detalles: respuesta, UsuarioId: usuario
                        });
                    }
                }

                $.ajax({
                    url: '/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Html.Raw(Json.Serialize(Model.Cedula.InmuebleId))+'/' + @Html.Raw(Json.Serialize(Model.Cedula.Id))+'?handler=ActualizarRespuestas',
                    type: "put",
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(cRespuestas),
                    success: function () {
                        Swal.fire({
                            icon: 'success',
                            title: 'Servicio de Mensajería Acelerada',
                            html: 'Se guardaron las respuestas de la cédula de evaluación correctamente.',
                            confirmButtonText: 'Cerrar'
                        }).then(function () {
                            Swal.fire({
                                allowOutsideClick: false,
                                icon: "info",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "Guardando el cuestionario, espere por favor."
                            });
                            Swal.showLoading();
                            window.location.reload();
                        });
                    }
                });
            });

            $(".desbloquearC").click(function () {
                Swal.fire({
                            icon: 'warning',
                            title: 'Servicio de Mensajería Acelerada',
                            html: '¿Está seguro que desea <b>Desbloquear</b> la cédula de evaluación?',
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Si, Desbloquear',
                            cancelButtonText: 'Cancelar',
                            showCancelButton: true
                        }).then(confirm => {
                            if (confirm.isConfirmed) {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    icon: "info",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Desbloqueando la cédula de evaluación, espere por favor."
                                });
                                Swal.showLoading();
                                axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=UpdateCedula', {
                                    Id: parseInt(cedula.id),
                                    EstatusId: $(this).data("estatusid"),
                                    UsuarioId: usuario,
                                    RepositorioId: parseInt(repositorio),
                                    EFacturaId: parseInt($(this).data('efacturaid')),
                                    //SE AGREGA ENOTACREDITOID
                                    ENotaCreditoId: parseInt($(this).data('enotaid')),
                                    Observaciones: "Se desbloquea la cédula de evaluación.",
                                    Flujo: supervision, Bloqueada: false, Elimina: true, Flujo: supervision
                                }).then(response => {
                                    if (response.status == 200) {
                                        Swal.fire({
                                            icon: "success",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "La cédula de evaluación fue desbloqueada correctamente.",
                                            confirmButtonText: 'Cerrar'
                                        }).then(function () {
                                            window.location.reload();
                                        });
                                    }
                                }).catch(error => {
                                    Swal.fire({
                                        icon: "error",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "Hubo un error al enviar la cédula. Contacte a su administrador del sistema.",
                                        confirmButtonText: 'Cerrar'
                                    });
                                });
                            }
                        });
            });

            $(".enviarCedula").click(function () {
                if (validaCuestionario()) {
                    if (validaEntregables()) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Servicio de Mensajería Acelerada',
                            html: '¿Está seguro que desea <b>Enviar a DAS</b> la cédula de evaluación?',
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Si, Enviar',
                            cancelButtonText: 'Cancelar',
                            showCancelButton: true
                        }).then(confirm => {
                            if (confirm.isConfirmed) {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    icon: "info",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Enviando la cédula de evaluación, espere por favor."
                                });
                                Swal.showLoading();
                                axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=UpdateCedula', {
                                    Id: parseInt(cedula.id),
                                    EstatusId: $(this).data("estatusid"),
                                    Calcula: true,
                                    UsuarioId: usuario,
                                    EFacturaId: parseInt($(this).data('efacturaid')),
                                    //SE AGREGA ENOTACREDITOID
                                    ENotaCreditoId: parseInt($(this).data('enotaid')),
                                    RepositorioId: parseInt(repositorio), Observaciones: "Se envía la cédula de evaluación a su revisión por la DAS.",
                                    Flujo: supervision,
                                    ServicioId: parseInt(modulo.servicioId),
                                    Bloqueada: false
                                }).then(response => {
                                    if (response.status == 200) {
                                        Swal.fire({
                                            icon: (response.data.bloqueada == true ? "error":"success"),
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: (response.data.bloqueada == true ?
                                                    "La cédula de evaluación fue <b class='text-danger'>Bloqueada</b> debido a que aún existen guías pendientes de dar seguimiento.":
                                                    "La cédula de evaluación fue enviada correctamente."
                                                ),
                                            confirmButtonText: 'Cerrar'
                                        }).then(function () {
                                            Swal.fire({
                                                allowOutsideClick: false,
                                                icon: "info",
                                                title: 'Servicio de Mensajería Acelerada',
                                                html: "Actualizando la cédula de evaluación, espere por favor."
                                            });
                                            Swal.showLoading();
                                            window.location.reload();
                                        });
                                    }
                                }).catch(error => {
                                    Swal.fire({
                                        icon: "error",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "Hubo un error al enviar la cédula. Contacte a su administrador del sistema.",
                                        confirmButtonText: 'Cerrar'
                                    });
                                });
                            }
                        });
                    }
                } else {

                }
            });

            $(".generarCedula").click(function () {
                axios.get('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?inmueble='+cedula.inmueble+'&handler=RevisarFirmantes').then(cedula => {
                    if (cedula.status == 200 && cedula.data != null) {
                        Swal.fire({
                            allowOutsideClick: false,
                            icon: "info",
                            title: 'Servicio de Mensajería Acelerada',
                            html: "Se generó la cédula de evaluación.",
                            confirmButtonText: 'Cerrar'
                        });
                        Swal.showLoading();
                        window.open('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/cedula/' + @Model.Repositorio.Id+'/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id, '_blank');
                        Swal.hideLoading();
                    }
                    else
                    {
                        Swal.fire({
                            allowOutsideClick: false,
                            icon: "error",
                            title: 'Servicio de Mensajería Acelerada',
                            html: "<p style='text-align: justify'>Error no se puede generar la <b>Cédula de Evaluación</b>, favor de capturar previamente a los servidores públicos que firmarán electrónicamente la cédula de evaluación.</p>",
                            confirmButtonText: 'Capturar'
                        }).then(function () {
                            limpiaFirmantes()
                            $(".inmuebleReviso").val(inmueble.id);
                            $(".inmuebleSuperviso").val(inmueble.id);
                            $("#modal-firmante").modal("show");
                        });
                    }
                });
            });

            $("#actualizarFirmante").click(function () {
                var reviso = $("#firmanteReviso").val();
                var escolaridadR = $("#escolaridadReviso").val();
                var inmuebleR = $(".inmuebleReviso").val();
                var superviso = $("#firmanteSuperviso").val();
                var escolaridadS = $("#escolaridadSuperviso").val();
                var inmuebleS = $(".inmuebleSuperviso").val();

                Swal.fire({
                    allowOutsideClick: false,
                    icon: "info",
                    title: 'Servicio de Mensajería Acelerada',
                    html: "Autorizando los firmantes, espere por favor."
                });
                Swal.showLoading();
                axios.post('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?Handler=CreateFirmante', {
                    InmuebleId: parseInt(inmuebleR), UsuarioId: reviso, Escolaridad: escolaridadR, Tipo: "Reviso"
                }).then(response => {
                    if (response.status && response.data != null)
                    {
                        axios.post('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?Handler=CreateFirmante', {
                            InmuebleId: parseInt(inmuebleS), UsuarioId: superviso, Escolaridad: escolaridadS, Tipo: "Superviso"
                        }).then(response => {
                            if (response.status && response.data != null)
                            {
                                Swal.fire({
                                    'icon': 'success',
                                    'title': 'Servicio de Mensajería Acelerada',
                                    'html': '<p class="text-justify">Los firmantes se guardaron correctamente. Por favor, nuevamente intente generar su entregable.',
                                    confirmButtonText: 'Cerrar'
                                }).then(function () {
                                    $("#modal-firmante").modal("hide");
                                });
                            }
                        }).catch(error => {
                            Swal.fire({
                                'icon': 'error',
                                title: 'Servicio de Mensajería Acelerada',
                                'html': 'Hubo un error al guardar al firmante que <b>Supervisa</b> el servicio. Contacte al administrador del sistema.'
                            });
                        });
                    }
                }).catch(error => {
                    Swal.fire({
                        'icon': 'error',
                        title: 'Servicio de Mensajería Acelerada',
                        'html': 'Hubo un error al guardar al firmante que <b>Revisa</b> el servicio. Contacte al administrador del sistema.'
                    });
                });
            });

            $(".autorizar").click(function () {
                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Está seguro que desea <b>Autorizar</b> la cédula de evaluación?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, Autorizar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Servicio de Mensajería Acelerada',
                            text: 'Por favor capture los comentarios.',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            cancelButtonText: 'Cancelar',
                            confirmButtonText: 'Autorizar',
                            input: 'textarea',
                            inputPlaceholder: 'Escriba los comentarios correspondientes'
                        }).then(coments => {
                            if (coments.value.length > 0) {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    icon: "info",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Autorizando la cédula de evaluación, espere por favor."
                                });
                                Swal.showLoading();
                                axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=UpdateCedula', {
                                    Id: parseInt(cedula.id), EstatusId: $(this).data("estatusid"), UsuarioId: usuario,
                                    EFacturaId: parseInt($(this).data('efacturaid')),
                                    //SE AGREGA ENOTACREDITOID
                                    ENotaCreditoId: parseInt($(this).data('enotaid')),
                                    RepositorioId: parseInt(repositorio),
                                    ServicioId: parseInt(modulo.servicioId),
                                    Observaciones: coments.value, Flujo: supervision
                                }).then(response => {
                                    if (response.status == 200) {
                                        Swal.fire({
                                            icon: "success",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "La cédula de evaluación se autorizó correctamente.",
                                            confirmButtonText: 'Cerrar'
                                        }).then(function () {
                                            Swal.fire({
                                                allowOutsideClick: false,
                                                icon: "info",
                                                title: 'Servicio de Mensajería Acelerada',
                                                html: "Actualizando la cédula de evaluación, espere por favor."
                                            });
                                            Swal.showLoading();
                                            window.location.reload();
                                        });
                                    }
                                }).catch(error => {
                                    Swal.fire({
                                        icon: "error",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "Hubo un error al autorizar la cédula de evaluación. Contacte a su administrador del sistema.",
                                        confirmButtonText: 'Cerrar'
                                    });
                                });
                            }
                        })
                    }
                });
            });

            $(".rechazar").click(function () {
                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Está seguro que desea <b>Rechazar</b> la cédula de evaluación?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, Rechazar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Servicio de Mensajería Acelerada',
                            text: 'Por favor capture el motivo por el cual rechaza la cédula.',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            cancelButtonText: 'Cancelar',
                            confirmButtonText: 'Rechazar',
                            input: 'textarea',
                            inputPlaceholder: 'Escriba los comentarios correspondientes'
                        }).then(coments => {
                            if (coments.value.length > 0) {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    icon: "info",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Rechazando la cédula de evaluación, espere por favor."
                                });
                                Swal.showLoading();
                                axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=UpdateCedula', {
                                    Id: parseInt(cedula.id),
                                    EstatusId: $(this).data("estatusid"),
                                    //SE AGREGA ENOTACREDITOID
                                    ENotaCreditoId: parseInt($(this).data('enotaid')),
                                    Observaciones: coments.value,
                                    EFacturaId: parseInt($(this).data('efacturaid')),
                                    RepositorioId: parseInt(repositorio),
                                    ServicioId: parseInt(modulo.servicioId),
                                    Mes: cedula.mes.nombre,
                                    UsuarioId: usuario,
                                    Flujo: supervision,
                                    Elimina: $(this).data('elimina')
                                }).then(response => {
                                    if (response.status == 200) {
                                        Swal.fire({
                                            icon: "success",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "La cédula de evaluación se rechazó correctamente.",
                                            confirmButtonText: 'Cerrar'
                                        }).then(function () {
                                            Swal.fire({
                                                allowOutsideClick: false,
                                                icon: "info",
                                                title: 'Servicio de Mensajería Acelerada',
                                                html: "Actualizando la cédula de evaluación, espere por favor."
                                            });
                                            Swal.showLoading();
                                            window.location.reload();
                                        });
                                    }
                                }).catch(error => {
                                    Swal.fire({
                                        icon: "error",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "Hubo un error al autorizar la cédula de evaluación. Contacte a su administrador del sistema.",
                                        confirmButtonText: 'Cerrar'
                                    });
                                });
                            }
                        })
                    }
                });
            });

            $(".revisarCAE").click(function () {

             // Obtén el valor de la penalización del modelo Razor
             const penalizacion = @(Math.Round(((tdeductivasB + deductivaCalidad) * 1.16m) + tdeductivas, 2));
             // Obtén el total de las notas de crédito que calculamos en Razor (la variable C# totalNotasCredito)
             const totalNotasCreditoCalculado = @totalNotasCredito; // Aquí se inyecta el valor calculado por Razor

                console.log("Penalización de la Cédula:", penalizacion);
                console.log("Total de Notas de Crédito (NC):", totalNotasCreditoCalculado);

                if (!validaNC()) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Servicio de Mensajería Acelerada',
                        html: 'La cédula cuenta con deductivas y aún no se adjunta la <b>Nota de Crédito</b>, favor de contactar a la <b>DAS</b>.',
                        confirmButtonText: 'Cerrar'
                    });

                    return false;
                }


                if (!(totalNotasCreditoCalculado >= penalizacion)) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Servicio de Mensajería Acelerada',
                        html: `El total de las notas de crédito cargadas en el sistema <b style="color: red;">NO COINCIDE</b> con el total de las deductivas calculadas.<br><br>
                               Notas de Crédito Cargadas: $${totalNotasCreditoCalculado}<br>
                               Deductivas calculadas con IVA: $${penalizacion}
                                <br><br>
                               Por favor, verifica las notas de crédito cargadas o contacta al personal de operación de la <b style="color: red;">Dirección de Aministración de Servicios</b>.`,
                        confirmButtonText: 'Cerrar',
                        background: '#FFFFFF',
                        customClass: {
                                   popup: 'border-danger border-3 large-swal-popup'
                        },
                        backdrop: `rgba(0,0,0,0.8)`,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        allowEnterKey: false
                    });

                    return false;
                }

                if (validaEntregables()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Servicio de Mensajería Acelerada',
                        html: '¿Está seguro que desea <b>Enviar a revisión por la CAE</b> la cédula de evaluación?',
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Si, enviar',
                        cancelButtonText: 'Cancelar',
                        showCancelButton: true
                    }).then(confirm => {
                        if (confirm.isConfirmed) {
                            Swal.fire({
                                allowOutsideClick: false,
                                icon: "info",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "Enviando la cédula de evaluación a revisión CAE, espere por favor."
                            });
                            Swal.showLoading();
                            axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=UpdateCedula', {
                                Id: parseInt(cedula.id), EstatusId: $(this).data("estatusid"),
                                UsuarioId: usuario,
                                RepositorioId: parseInt(repositorio),
                                EFacturaId: parseInt($(this).data('efacturaid')),
                                //SE AGREGA ENOTACREDITOID
                                ENotaCreditoId: parseInt($(this).data('enotaid')),
                                ServicioId: parseInt(modulo.servicioId),
                                Observaciones: "Se envía la cédula a revisión por parte de la CAE.",
                                Flujo: supervision
                            }).then(response => {
                                if (response.status == 200) {
                                    Swal.fire({
                                        icon: "success",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "La cédula de evaluación se envió a revisión de la CAE correctamente.",
                                        confirmButtonText: 'Cerrar'
                                    }).then(function () {
                                        Swal.fire({
                                            allowOutsideClick: false,
                                            icon: "info",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "Actualizando la cédula de evaluación, espere por favor."
                                        });
                                        Swal.showLoading();
                                        window.location.reload();
                                    });
                                }
                            }).catch(error => {
                                Swal.fire({
                                    icon: "error",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Hubo un error al autorizar la cédula de evaluación. Contacte a su administrador del sistema.",
                                    confirmButtonText: 'Cerrar'
                                });
                            });
                        }
                    });
                }
            });

            $(".autorizarCAE").click(function () {
                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Está seguro que desea <b>Autorizar por la CAE</b> la cédula de evaluación?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, autorizar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        Swal.fire({
                            allowOutsideClick: false,
                            icon: "info",
                            title: 'Servicio de Mensajería Acelerada',
                            html: "Verificando la cédula de evaluación, espere por favor."
                        });
                        Swal.showLoading();
                        axios.post('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=AutorizarCAE', {
                            Id: parseInt(cedula.id)
                        }).then(confirm => {
                            if (confirm.data == 0) {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    icon: "info",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Autorizando la cédula de evaluación por la CAE, espere por favor."
                                });
                                Swal.showLoading();
                                axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=UpdateCedula', {
                                    Id: parseInt(cedula.id), EstatusId: $(this).data("estatusid"),
                                    UsuarioId: usuario,
                                    RepositorioId: parseInt(repositorio),
                                    EFacturaId: parseInt($(this).data('efacturaid')),
                                    //SE AGREGA ENOTACREDITOID
                                    ENotaCreditoId: parseInt($(this).data('enotaid')),
                                    ServicioId: parseInt(modulo.servicioId),
                                    Observaciones: "Se autoriza la cédula por parte de la CAE.",
                                    Flujo: supervision
                                }).then(response => {
                                    if (response.status == 200) {
                                        Swal.fire({
                                            icon: "success",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "La cédula de evaluación se autorizó por la CAE correctamente.",
                                            confirmButtonText: 'Cerrar'
                                        }).then(function () {
                                            Swal.fire({
                                                allowOutsideClick: false,
                                                icon: "info",
                                                title: 'Servicio de Mensajería Acelerada',
                                                html: "Actualizando la cédula de evaluación, espere por favor."
                                            });
                                            Swal.showLoading();
                                            window.location.reload();
                                        });
                                    }
                                });
                            }
                            else
                            {
                                Swal.fire({
                                    icon: "error",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Existen entregables pendientes de autorizar o rechazar. Favor de revisar.",
                                    confirmButtonText: 'Cerrar'
                                });
                            }
                        });
                    }
                });
            });

            $(".tramiteRechazado").click(function () {
                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Está seguro que desea <b>Rechazar el trámite</b> de la cédula de evaluación?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, Rechazar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        Swal.fire({
                            allowOutsideClick: false,
                            icon: "info",
                            title: 'Servicio de Mensajería Acelerada',
                            html: "Verificando la cédula de evaluación, espere por favor."
                        });
                        Swal.showLoading();
                        axios.post('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=TramiteRechazado', {
                            Id: parseInt(cedula.id)
                        }).then(confirm => {
                            if (confirm.data == 0)
                            {
                                Swal.fire({
                                    icon: 'info',
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: 'Por favor capture el motivo por el cual <b>Rechaza el trámite</b> de la cédula.',
                                    showCancelButton: true,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    cancelButtonText: 'Cancelar',
                                    confirmButtonText: 'Rechazar',
                                    input: 'textarea',
                                    inputPlaceholder: 'Escriba los comentarios correspondientes'
                                }).then(coments => {
                                    if (coments.value.length > 0) {
                                        Swal.fire({
                                            allowOutsideClick: false,
                                            icon: "info",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "Rechazando el trámite de la cédula de evaluación, espere por favor."
                                        });
                                        Swal.showLoading();
                                        axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=UpdateCedula', {
                                            Id: parseInt(cedula.id), EstatusId: $(this).data("estatusid"),
                                            EFacturaId: parseInt($(this).data('efacturaid')),
                                            //SE AGREGA ENOTACREDITOID
                                            ENotaCreditoId: parseInt($(this).data('enotaid')),
                                            UsuarioId: usuario,
                                            RepositorioId: parseInt(repositorio),
                                            ServicioId: parseInt(modulo.servicioId),
                                            Observaciones: coments.value,
                                            Elimina: $(this).data('elimina'),
                                            Flujo: supervision
                                        }).then(response => {
                                            if (response.status == 200) {
                                                Swal.fire({
                                                    icon: "success",
                                                    title: 'Servicio de Mensajería Acelerada',
                                                    html: "El trámite de la cédula de evaluación se rechazó correctamente.",
                                                    confirmButtonText: 'Cerrar'
                                                }).then(function () {
                                                    Swal.fire({
                                                        allowOutsideClick: false,
                                                        icon: "info",
                                                        title: 'Servicio de Mensajería Acelerada',
                                                        html: "Actualizando la cédula de evaluación, espere por favor."
                                                    });
                                                    Swal.showLoading();
                                                    window.location.reload();
                                                });
                                            }
                                        }).catch(error => {
                                            Swal.fire({
                                                icon: "error",
                                                title: 'Servicio de Mensajería Acelerada',
                                                html: "Hubo un error al autorizar la cédula de evaluación. Contacte a su administrador del sistema.",
                                                confirmButtonText: 'Cerrar'
                                            });
                                        });
                                    }
                                })
                            }
                            else
                            {
                                Swal.fire({
                                    icon: "error",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Existen entregables pendientes de autorizar o rechazar. Favor de revisar.",
                                    confirmButtonText: 'Cerrar'
                                });
                            }
                        });
                    }
                });
            });

            $(".tramitar").click(function () {
                  // Obtén el valor de la penalización del modelo Razor
             const penalizacion = @(Math.Round(((tdeductivasB + deductivaCalidad) * 1.16m) + tdeductivas, 2));
             // Obtén el total de las notas de crédito que calculamos en Razor (la variable C# totalNotasCredito)
             const totalNotasCreditoCalculado = @totalNotasCredito; // Aquí se inyecta el valor calculado por Razor

                console.log("Penalización de la Cédula:", penalizacion);
                console.log("Total de Notas de Crédito (NC):", totalNotasCreditoCalculado);


                 if (!validaNC()) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Servicio de Mensajería Acelerada',
                        html: 'La cédula cuenta con deductivas y aún no se adjunta la <b>Nota de Crédito</b>, favor de contactar a la <b>DAS</b>.',
                        confirmButtonText: 'Cerrar'
                    });

                    return false;
                }

                if (!(totalNotasCreditoCalculado >= penalizacion)) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Servicio de Mensajería Acelerada',
                        html: `El total de las notas de crédito cargadas en el sistema <b style="color: red;">NO COINCIDE</b> con el total de las deductivas calculadas.<br><br>
                               Notas de Crédito Cargadas: $${totalNotasCreditoCalculado}<br>
                               Deductivas calculadas con IVA: $${penalizacion}
                                <br><br>
                               Por favor, verifica las notas de crédito cargadas o contacta al personal de operación de la <b style="color: red;">Dirección de Aministración de Servicios</b>.`,
                        confirmButtonText: 'Cerrar',
                        background: '#FFFFFF',
                        customClass: {
                            popup: 'border-danger border-3 large-swal-popup'
                        },
                        backdrop: `rgba(0,0,0,0.8)`,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        allowEnterKey: false
                    });

                    return false;
                }

                if (validaEntregables()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Servicio de Mensajería Acelerada',
                        html: '¿Está seguro que desea <b>Tramitar</b> la cédula de evaluación?',
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Si, tramitar',
                        cancelButtonText: 'Cancelar',
                        showCancelButton: true
                    }).then(confirm => {
                        if (confirm.isConfirmed) {
                            Swal.fire({
                                allowOutsideClick: false,
                                icon: "info",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "Tramitando la cédula de evaluación, espere por favor."
                            });
                            Swal.showLoading();
                            axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=UpdateCedula', {
                                Id: parseInt(cedula.id), EstatusId: $(this).data("estatusid"),
                                EFacturaId: parseInt($(this).data('efacturaid')),
                                //SE DEFINIO ENOTA PARA ESTATUS TRAMITAR
                                ENotaCreditoId: parseInt($(this).data('enotaid')),
                                UsuarioId: usuario,
                                RepositorioId: parseInt(repositorio),
                                ServicioId: parseInt(modulo.servicioId),
                                Observaciones: "Se tramita la cédula por parte de la administración.",
                                Flujo: supervision
                            }).then(response => {
                                if (response.status == 200) {
                                    Swal.fire({
                                        icon: "success",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "La cédula de evaluación se tramitó correctamente.",
                                        confirmButtonText: 'Cerrar'
                                    }).then(function () {
                                        Swal.fire({
                                            allowOutsideClick: false,
                                            icon: "info",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "Actualizando la cédula de evaluación, espere por favor."
                                        });
                                        Swal.showLoading();
                                        window.location.reload();
                                    });
                                }
                            });
                        }
                    });
                }

            });

            $(".tramitePago").click(function () {
                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Está seguro que desea <b>Tramitar a Pago</b> la cédula de evaluación?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, tramitar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        axios.post('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=TramitarPago', {
                            Id: parseInt(cedula.id)
                        }).then(confirm => {
                            if (confirm.data == 200) {
                                axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=UpdateCedula', {
                                    Id: parseInt(cedula.id), EstatusId: $(this).data("estatusid"),
                                    EFacturaId: parseInt($(this).data('efacturaid')),
                                    //SE AGREGA ENOTACREDITOID
                                    ENotaCreditoId: parseInt($(this).data('enotaid')),
                                    UsuarioId: usuario,
                                    RepositorioId: parseInt(repositorio),
                                    ServicioId: parseInt(modulo.servicioId),
                                    Observaciones: "Se envió a trámite de pago la cédula de evaluación.",
                                    Flujo: supervision
                                }).then(response => {
                                    if (response.status == 200) {
                                        Swal.fire({
                                            icon: "success",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "La cédula de evaluación se tramitó a pago correctamente.",
                                            confirmButtonText: 'Cerrar'
                                        }).then(function () {
                                            Swal.fire({
                                                allowOutsideClick: false,
                                                icon: "info",
                                                title: 'Servicio de Mensajería Acelerada',
                                                html: "Actualizando la cédula de evaluación, espere por favor."
                                            });
                                            Swal.showLoading();
                                            window.location.reload();
                                        });
                                    }
                                });
                            }
                            else if(confirm.data == 206)
                            {
                                Swal.fire({
                                    icon: "error",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Existen entregables pendientes. Favor de revisar.",
                                    confirmButtonText: 'Cerrar'
                                });
                            }
                            else if (confirm.data == 207)
                            {
                                Swal.fire({
                                    icon: "error",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "<p style='text-align: justify'>Verifique que ya fueron validados los siguientes entregables:<br />" +
                                          "- <b>Memorándum</b><br>"+
                                          "- <b>Acta Entrega - Recepción (Firmada)</b><br>" +
                                          "- <b>Cédula Firmada (FIREL)</b>.<br></p>",
                                    confirmButtonText: 'Cerrar'
                                  });
                            }
                            else
                            {
                                Swal.fire({
                                    icon: "error",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Aún no se válida el <b>Acuse Memorándum (Firel)</b>.",
                                    confirmButtonText: 'Cerrar'
                                });
                            }
                        });
                    }
                });
            });

            function limpiaFirmantes() {
                $("#firmanteReviso").val('');
                $("#escolaridadReviso").val('');
                $(".inmuebleReviso").val('');
                $("#firmanteSuperviso").val('');
                $("#escolaridadSuperviso").val('');
                $(".inmuebleSuperviso").val('');
            }

            function validaCuestionario() {
                var complete = false;
                var preguntas = "";
                for (var i = 0; i < respuestas.length; i++) {
                    let respuesta = $("input[name='" + respuestas[i].cuestionario.abreviacion + "']:checked").val();
                    if (respuesta != null && respuesta != undefined) {
                        if (respuestas[i].ciMensajeria.respuesta + "" == respuesta && respuestas[i].ciMensajeria.obligatorio + "" == "true") {
                            if (cuentaIncidencias(cedula.id, respuestas[i].pregunta) == 0) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: 'Debe registrar la(s) incidencia(s) correspondientes en la <b>Pregunta ' + (i + 1) + '</b>',
                                    confirmButtonText: 'Cerrar'
                                });
                                return false;
                            }
                        }
                    }
                    else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Servicio de Mensajería Acelerada',
                            html: 'Debe contestar la <b>Pregunta ' + (i + 1) + '</b>',
                            confirmButtonText: 'Cerrar'
                        });

                        return false;
                    }
                }

                for (var i = 0; i < respuestas.length; i++) {
                    let respuesta = $("input[name='" + respuestas[i].cuestionario.abreviacion + "']:checked").val();
                    console.log("P: " + respuestas[i].cuestionario.abreviacion + " R: " + respuestas[i].respuesta + " RA: " + respuesta);
                    if (respuestas[i].respuesta + "" != respuesta + "" && respuesta != "N/A") {
                        Swal.fire({
                            icon: 'error',
                            title: 'Servicio de Mensajería Acelerada',
                            html: 'Debe guardar el cuestionario antes de enviar a revisión por la DAS.',
                            confirmButtonText: 'Cerrar'
                        });
                        return false;
                    }
                }
                return true;
            }

            function cuentaIncidencias(cedula, pregunta) {
                var isContinue = true;
                $.ajax({
                    url: '/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?Cedula=' + cedula + '&Pregunta=' + pregunta + '&handler=Incidencias',
                    type: 'GET',
                    async: false,
                    success: function (json) {
                        json == 0 ? isContinue = false : true;
                    },
                });
                return isContinue;
            }

            function validaEntregables() {
                var e = "";
                for (var i = 0; i < entregables.length; i++) {
                    if (entregables[i].archivo == null || entregables[i].archivo == "" || entregables[i].estatus.nombre == "Rechazado") {
                        e += "<b>- " + entregables[i].tipoEntregable.nombre + "</b><br>";
                    }
                }

                if (e != "") {
                    Swal.fire({
                        icon: 'error',
                        title: 'Servicio de Mensajería Acelerada',
                        html: 'Se deben adjuntar los siguientes entregables: <br>' + e,
                        confirmButtonText: 'Cerrar'
                    });

                    return false;
                }
                else {
                    return true;
                }
            }

            function validaNC() {
                if (penasDeductivas != 0 && existsNC != 0)
                {
                    return true;

                }
                else if (penasDeductivas != 0 && existsNC == 0)
                {
                    return false;
                }
                else if (penasDeductivas == 0)
                {
                    return true;
                }
            }

            function guardarCedula() {
                var cRespuestas = new Array();

                for (var i = 0; i < respuestas.length; i++) {
                    let respuesta = $("input[name='" + respuestas[i].cuestionario.abreviacion + "']:checked").val();
                    if (respuesta != null && respuesta != undefined && respuesta != "N/A") {
                        cRespuestas.push({ CedulaEvaluacionId: parseInt(cedula.id), Pregunta: (i + 1),
                            Respuesta: (respuesta == "true"), UsuarioId: usuario });
                    } else if (respuesta == "N/A") {
                        cRespuestas.push({
                            CedulaEvaluacionId: parseInt(cedula.id), Pregunta: (i + 1),
                            Respuesta: (respuesta == "true"), Detalles: respuesta, UsuarioId: usuario
                        });
                    }
                }

                $.ajax({
                    url: '/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Html.Raw(Json.Serialize(Model.Cedula.InmuebleId))+'/' + @Html.Raw(Json.Serialize(Model.Cedula.Id))+'?handler=ActualizarRespuestas',
                    type: "put",
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(cRespuestas),
                    success: function () {
                        Swal.fire({
                            icon: 'success',
                            title: 'Servicio de Mensajería Acelerada',
                            html: 'Se guardaron las respuestas de la cédula de evaluación correctamente.',
                            confirmButtonText: 'Cerrar'
                        }).then(function () {
                            Swal.fire({
                                allowOutsideClick: false,
                                icon: "info",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "Actualizando el cuestionario, espere por favor."
                            });
                            Swal.showLoading();
                            window.location.reload();
                        });
                    }
                });
            }

            function guardarCedulaCP(obligatorio, pregunta, respuesta) {
                var cRespuestas = new Array();

                for (var i = 0; i < respuestas.length; i++) {
                    let respuesta = $("input[name='" + respuestas[i].cuestionario.abreviacion + "']:checked").val();
                    if (respuesta != null && respuesta != undefined && respuesta != "N/A") {
                        cRespuestas.push({ CedulaEvaluacionId: parseInt(cedula.id), Pregunta: (i + 1),
                            Respuesta: (respuesta == "true"), UsuarioId: usuario });
                    } else if (respuesta == "N/A") {
                        cRespuestas.push({
                            CedulaEvaluacionId: parseInt(cedula.id), Pregunta: (i + 1),
                            Respuesta: (respuesta == "true"), Detalles: respuesta, UsuarioId: usuario
                        });
                    }
                }

                $.ajax({
                    url: '/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Html.Raw(Json.Serialize(Model.Cedula.InmuebleId))+'/' + @Html.Raw(Json.Serialize(Model.Cedula.Id))+'?handler=ActualizarRespuestas',
                    type: "put",
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(cRespuestas),
                    success: function () {
                        if (obligatorio && respuesta != "N/A") {
                            Swal.fire({
                                allowOutsideClick: false,
                                icon: "warning",
                                title: "Servicio de Mensajería Acelerada",
                                html: "La <b>Pregunta " + pregunta + " requiere</b> captura de incidencias.",
                                confirmButtonText: 'Cerrar'
                            }).then(function () {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    icon: "info",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Cargando información para la captura de incidencias, espere por favor."
                                });
                                Swal.showLoading();
                                window.location.reload();
                            });
                        }
                        else {
                            Swal.fire({
                                allowOutsideClick: false,
                                icon: "info",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "Guardando información, espere por favor."
                            });
                            Swal.showLoading();
                            window.location.reload();
                        }
                    }
                });
            }

            $(".generaAER").click(function () {
                axios.get('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?inmueble='+cedula.inmueble+'&handler=RevisarFirmantes').then(cedula => {
                    if (cedula.status == 200 && cedula.data != null)
                    {
                        Swal.fire({
                            allowOutsideClick: false,
                            icon: "info",
                            title: 'Servicio de Mensajería Acelerada',
                            html: "Generando el <b>Acta Entrega - Recepción</b> de la evaluación, espere por favor."
                        });
                        Swal.showLoading();
                        if (penasDeductivas == 0 || existsNC != 0) {
                            axios.get('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?nFacturacion=' +@Model.Repositorio.Id+'&CedulaId=' +@Model.Cedula.Id+'&nInmueble=' +@Model.Inmueble.Id+'&Supervision=' + supervision + '&Handler=ActaEntregaRecepcion', { responseType: 'blob' }).then(response => {
                                if (response.status == 200) {
                                    const href = URL.createObjectURL(response.data);
                                    const link = document.createElement('a');
                                    link.href = href;
                                    link.setAttribute('download', 'Acta_Entrega_Recepcion_Mensajeria_Recepcion.docx');
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    URL.revokeObjectURL(href);
                                    Swal.fire({
                                        allowOutsideClick: false,
                                        icon: "info",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "El <b>Acta Entrega - Recepción</b> se descargó correctamente. <p class='text-justify mt-3'>" +
                                               "<b class='text-danger'>Sugerencia:</b> En caso de que se generé una hoja en blanco favor de eliminarla.</p>",
                                        confirmButtonText: 'Cerrar'
                                    });
                                    Swal.hideLoading();
                                }
                            });
                        }
                        else
                        {
                            Swal.fire({
                                icon: "error",
                                title: 'Servicio de Mensajería Acelerada',
                                html: "No es posible generar el <b>Acta Entrega - Recepción</b> ya que aún no se adjunta el XML de la <b>Nota de Crédito</b>.",
                                confirmButtonText: 'Cerrar'
                            });
                        }
                    }
                    else
                    {
                        Swal.fire({
                            allowOutsideClick: false,
                            icon: "error",
                            title: 'Servicio de Mensajería Acelerada',
                            html: "<p style='text-align: justify'>Error no se puede generar el <b>Acta Entrega - Recepción</b>, favor de capturar previamente a los servidores públicos que firmarán electrónicamente la cédula de evaluación.</p>",
                            confirmButtonText: 'Capturar'
                        }).then(function () {
                            limpiaFirmantes()
                            $(".inmuebleReviso").val(inmueble.id);
                            $(".inmuebleSuperviso").val(inmueble.id);
                            $("#modal-firmante").modal("show");
                        });
                    }
                });
            });

            $(".btnAyuda").click(function () {
                var msg = $(this).data("ayuda");
                Swal.fire({
                    'customClass': 'swal-wide',
                    'icon': "info",
                    'title': 'Servicio de Mensajería Acelerada',
                    'confirmButtonText': 'Cerrar',
                    'html': msg
                });
            });

            $(".btnAyudaI").click(function () {
                var msg = $(this).data("ayuda");
                if (msg != "") {
                    Swal.fire({
                        'customClass': 'swal-wide',
                        'icon': "info",
                        'title': 'Servicio de Mensajería Acelerada',
                        'confirmButtonText': 'Cerrar',
                        'html': msg
                    });
                } else {
                    $(this).css("display","none");
                }
            });

            $(".solicitudRechazo").click(function () {
                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Está seguro que desea <b>Soliciar el Rechazo</b> de la cédula de evaluación?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, continuar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Servicio de Mensajería Acelerada',
                            html: '<p style = "text-align: justify">Por favor capture el motivo por el cual solicita el rechazo de la cédula. <br/><br/>' +
                                   '<b class= "text-danger" >Advertencia: </b> En caso de que se autorice el <b>Rechazo de la cédula</b> todos los entregables '+
                                   'a <b>excepción de la "Factura" y la "Validación del SAT"</b> serán eliminados.<br/><br/>'+
                                   '<b class= "text-danger" >Una vez eliminados los entregables no se podrán recuperar. </b></p>',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            cancelButtonText: 'Cancelar',
                            confirmButtonText: 'Solicitar rechazo',
                            input: 'textarea',
                            inputPlaceholder: 'Escriba los comentarios correspondientes'
                        }).then(coments => {
                            if (coments.value.length > 0) {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    icon: "info",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Solicitando el rechazo de la cédula de evaluación, espere por favor."
                                });
                                Swal.showLoading();
                                axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=UpdateCedula', {
                                    Id: parseInt(cedula.id),
                                    UsuarioId: usuario,
                                    EstatusId: 14,
                                    Estatus: "En Revisión",
                                    Bloqueada: true,
                                    Aprobada: true,
                                    Flujo: supervision,
                                    ServicioId: parseInt(modulo.servicioId),
                                    Observaciones: coments.value,
                                }).then(response => {
                                    if (response.status == 200) {
                                        Swal.fire({
                                            icon: "success",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "Se envió la solicitud del rechazó correctamente.",
                                            confirmButtonText: 'Cerrar'
                                        }).then(function () {
                                            Swal.fire({
                                                allowOutsideClick: false,
                                                icon: "info",
                                                title: 'Servicio de Mensajería Acelerada',
                                                html: "Actualizando la cédula de evaluación, espere por favor."
                                            });
                                            Swal.showLoading();
                                            window.location.reload();
                                        });
                                    }
                                }).catch(error => {
                                    Swal.fire({
                                        icon: "error",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "Hubo un error al autorizar la cédula de evaluación. Contacte a su administrador del sistema.",
                                        confirmButtonText: 'Cerrar'
                                    });
                                });
                            }
                        })
                    }
                });
            });

            $(".denegarRechazo").click(function () {
                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Está seguro que desea <b>Denegar el Rechazo</b> de la cédula de evaluación?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, continuar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Servicio de Mensajería Acelerada',
                            text: 'Por favor capture el motivo por el cual solicita el deniega el rechazo de la cédula.',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            cancelButtonText: 'Cancelar',
                            confirmButtonText: 'Denegar rechazo',
                            input: 'textarea',
                            inputPlaceholder: 'Escriba los comentarios correspondientes'
                        }).then(coments => {
                            if (coments.value.length > 0) {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    icon: "info",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Denegando el rechazo de la cédula de evaluación, espere por favor."
                                });
                                Swal.showLoading();
                                axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=UpdateCedula', {
                                    Id: parseInt(cedula.id),
                                    UsuarioId: usuario,
                                    EstatusId: @Model.RevertirEstatus,
                                    Bloqueada: false,
                                    Aprobada: false,
                                    Flujo: supervision,
                                    Observaciones: coments.value,
                                }).then(response => {
                                    if (response.status == 200) {
                                        Swal.fire({
                                            icon: "success",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "Se denegó la solicitud del rechazó correctamente.",
                                            confirmButtonText: 'Cerrar'
                                        }).then(function () {
                                            Swal.fire({
                                                allowOutsideClick: false,
                                                icon: "info",
                                                title: 'Servicio de Mensajería Acelerada',
                                                html: "Actualizando la cédula de evaluación, espere por favor."
                                            });
                                            Swal.showLoading();
                                            window.location.reload();
                                        });
                                    }
                                }).catch(error => {
                                    Swal.fire({
                                        icon: "error",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "Hubo un error al autorizar la cédula de evaluación. Contacte a su administrador del sistema.",
                                        confirmButtonText: 'Cerrar'
                                    });
                                });
                            }
                        })
                    }
                });
            });

            $(".cancelarRechazo").click(function () {
                Swal.fire({
                    icon: 'warning',
                    title: 'Servicio de Mensajería Acelerada',
                    html: '¿Está seguro que desea <b>Cancelar el Rechazo</b> de la cédula de evaluación?',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, cancelar',
                    cancelButtonText: 'Cancelar',
                    showCancelButton: true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Servicio de Mensajería Acelerada',
                            text: 'Por favor capture el motivo por el cual cancela el rechazo de la cédula.',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            cancelButtonText: 'Cancelar',
                            confirmButtonText: 'Cancelar rechazo',
                            input: 'textarea',
                            inputPlaceholder: 'Escriba los comentarios correspondientes'
                        }).then(coments => {
                            if (coments.value.length > 0) {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    icon: "info",
                                    title: 'Servicio de Mensajería Acelerada',
                                    html: "Cancelando la solicitud de rechazo de la cédula de evaluación, espere por favor."
                                });
                                Swal.showLoading();
                                axios.put('/mensajeria/' + @Model.Modulo.Id+'/' + @Model.Submodulo.Id+'/detalle/' + @Model.Inmueble.Id+'/' + @Model.Cedula.Id+'?handler=DenegarSolicitudRechazo', {
                                    Id: parseInt(cedula.id),
                                    UsuarioId: usuario,
                                    EstatusId: @Model.RevertirEstatus,
                                    Bloqueada: false,
                                    Aprobada: false,
                                    ServicioId: parseInt(modulo.servicioId),
                                    Observaciones: coments.value,
                                }).then(response => {
                                    if (response.status == 200) {
                                        Swal.fire({
                                            icon: "success",
                                            title: 'Servicio de Mensajería Acelerada',
                                            html: "Se canceló la solicitud del rechazo correctamente.",
                                            confirmButtonText: 'Cerrar'
                                        }).then(function () {
                                            Swal.fire({
                                                allowOutsideClick: false,
                                                icon: "info",
                                                title: 'Servicio de Mensajería Acelerada',
                                                html: "Actualizando la cédula de evaluación, espere por favor."
                                            });
                                            Swal.showLoading();
                                            window.location.reload();
                                        });
                                    }
                                }).catch(error => {
                                    Swal.fire({
                                        icon: "error",
                                        title: 'Servicio de Mensajería Acelerada',
                                        html: "Hubo un error al cancelar la solicitud de la cédula de evaluación. Contacte a su administrador del sistema.",
                                        confirmButtonText: 'Cerrar'
                                    });
                                });
                            }
                        })
                    }
                });
            });

            /*********************************** Guardado de la Cédula **********************************/
        });
    </script>
}
